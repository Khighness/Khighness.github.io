<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>RabbitMQ | Khighness</title><meta name="keywords" content="MQ"><meta name="author" content="Khighness"><meta name="copyright" content="Khighness"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="不推荐从官网的通信模型开始入门，先理解交换机、队列和路由，从四大交换机开始入门。关注RabbitMQ的一些高级用法，死信队列、延时队列、可靠投递到交换机和可靠投递到队列。">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ">
<meta property="og:url" content="https://www.parak.top/posts/33708/index.html">
<meta property="og:site_name" content="Khighness">
<meta property="og:description" content="不推荐从官网的通信模型开始入门，先理解交换机、队列和路由，从四大交换机开始入门。关注RabbitMQ的一些高级用法，死信队列、延时队列、可靠投递到交换机和可靠投递到队列。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://khighness-blog.oss-cn-shanghai.aliyuncs.com/top/bg-46.jpg">
<meta property="article:published_time" content="2021-06-02T16:00:00.000Z">
<meta property="article:modified_time" content="2022-10-09T03:14:22.135Z">
<meta property="article:author" content="Khighness">
<meta property="article:tag" content="MQ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://khighness-blog.oss-cn-shanghai.aliyuncs.com/top/bg-46.jpg"><link rel="shortcut icon" href="https://khighness-blog.oss-cn-shanghai.aliyuncs.com/avatar/K.jpg"><link rel="canonical" href="https://www.parak.top/posts/33708/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//s4.cnzz.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?16576652";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" data-pjax="data-pjax" src="https://s4.cnzz.com/z_stat.php?id=1279324689&amp;web_id=1279324689"></script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Khighness","link":"链接: ","source":"来源: Khighness","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-09 11:14:22'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><link rel="stylesheet" href="/css/background.css"><link rel="stylesheet" href="/css/iconfont/iconfont.css"><link rel="stylesheet" href="/css/mouse.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/css/main.css"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Khighness" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="https://khighness-blog.oss-cn-shanghai.aliyuncs.com/avatar/Khighness.jpg" onerror="onerror=null;src='https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/404.jpg'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">93</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">24</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-index"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-tianchongxing-1"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-tianchongxing-"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw iconfont icon-fenlei"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-ziyuan"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-K"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://khighness-blog.oss-cn-shanghai.aliyuncs.com/top/bg-46.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Khighness</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-index"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-tianchongxing-1"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-tianchongxing-"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw iconfont icon-fenlei"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-ziyuan"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-K"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">RabbitMQ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-06-02T16:00:00.000Z" title="发表于 2021-06-03 00:00:00">2021-06-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-09T03:14:22.135Z" title="更新于 2022-10-09 11:14:22">2022-10-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/MiddleWare/">MiddleWare</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">19.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>91分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="RabbitMQ"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="1-消息队列概述"><a href="#1-消息队列概述" class="headerlink" title="1. 消息队列概述"></a>1. 消息队列概述</h2><h3 id="1-1-定义"><a href="#1-1-定义" class="headerlink" title="1.1 定义"></a>1.1 定义</h3><p>MQ(Message Queue)：消息队列，通过典型的生产者和消费者模型，生产者不断向消息队列中生产消息，消费者不断的从队列中 获取消息，因为消息的生产和消费都是异步的，而且只关心消息的发送和接收，没有业务逻辑的侵入，轻松的实现系统间解耦，别名为消息中间件。通过利用高效可靠的消息传递机制进行平台无关的数据交流，并基于数据通信来进行分布式系统的集成。</p>
<h3 id="1-2-应用场景"><a href="#1-2-应用场景" class="headerlink" title="1.2 应用场景"></a>1.2 应用场景</h3><ul>
<li>跨系统数据传递</li>
<li>高并发流量削峰</li>
<li>数据分发和异步处理</li>
<li>大数据分析传递</li>
<li>分布式事务</li>
</ul>
<h3 id="1-3-主流使用"><a href="#1-3-主流使用" class="headerlink" title="1.3 主流使用"></a>1.3 主流使用</h3><ol>
<li>ActiveMQ</li>
</ol>
<p>ActiveMQ是Apache出品，能力强劲的开源消息系统，它是一个完全支持JMS规范的消息中间件，丰富的API，多种集群架构模式让ActiveMQ在业界成为老牌的消息中间件，在中小型企业颇受欢迎。</p>
<ol start="2">
<li>Kafka</li>
</ol>
<p>Kafka是LinkedIn开源的分布式发布-订阅消息系统，目前归属于Apache顶级项目。Kafka主要特点是基于Pull的模式来处理消息消费，追求高吞吐量，一开始的目的就是用于日志收集和传输。0.8版本开始支持复制，不支持事务，对消息的重复、丢失、错误没有严格要求，适合产生大量数据的互联网服务的数据收集业务。</p>
<ol start="3">
<li>RocketMQ</li>
</ol>
<p>RocketMQ是阿里开源的消息中间件，它是纯Java开发，具有高吞吐量、高可用性、适合大规模分布式系统应用的特点。RocketMQ思路起源于Kafka，但并不是Kafka的一个Copy，它对消息和可靠传输及事务性做了优化，目前在阿里集团广泛应用于交易、充值、流计算、消息推送、日志流式处理、binglog分发等场景。</p>
<ol start="4">
<li>RabbitMQ</li>
</ol>
<p>RabbitMQ是使用Erlang语言开发的开源消息队列系统，基于AMQP协议来实现。AMQP的主要特征是面向消息、队列、路由（包括点对点和发布/订阅）、可靠性、安全、AMQP协议更多用在企业系统内对数据一致性、稳定性和可靠性要求很高的场景，对性能和吞吐量的要求还在其次。</p>
<h2 id="2-消息队列协议"><a href="#2-消息队列协议" class="headerlink" title="2. 消息队列协议"></a>2. 消息队列协议</h2><h3 id="2-1-AMQP协议"><a href="#2-1-AMQP协议" class="headerlink" title="2.1 AMQP协议"></a>2.1 AMQP协议</h3><p>AMQP(Advanced Message Queuing Protocol)是高级消息队列协议，由摩根大通集团连接其他公司共同设计，是一个提供统一消息服务的应用层标准高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。基于此协议的客户端和消息中间件可传递消息，并不受客户端/中间件不同产品、不同的开发语言等条件的限制。</p>
<h3 id="2-2-MQTT协议"><a href="#2-2-MQTT协议" class="headerlink" title="2.2 MQTT协议"></a>2.2 MQTT协议</h3><p>MQTT(Meesgae Queuing Telemetry Transport)消息队列是IBM开放的一个即时通讯协议，物联网系统架构中的重要组成部分。</p>
<h3 id="2-3-OpenMeesage协议"><a href="#2-3-OpenMeesage协议" class="headerlink" title="2.3 OpenMeesage协议"></a>2.3 OpenMeesage协议</h3><p>近几年由阿里巴巴、雅虎和滴滴出行、Stremalio等公司共同参与创立的分布式消息中间件、流处理等领域的应用开发标准。</p>
<blockquote>
<p>为什么不使用http协议？</p>
</blockquote>
<p>（1）因为http请求报文头和响应报文头是比较复杂的，包含了cookie、数据的加密解密、状态码等附加功能，但是对于一个消息而言，并不需要这么复杂，只需要数据传递、存储和分发就行，追求的是高性能，尽量简洁和快速。</p>
<p>（2）大部分情况下http是短连接，在实际的交互过程中，一个请求到响应很有可能会中断，中断以后就不会进行持久化，就会造成请求的丢失。这样就不利于消息中间件的业务场景，因为消息中间件可能是一个长期的获取消息的过程，出现问题和故障要对数据或消息进行持久化等，目的是为了保证消息和数据的高可靠和稳健的运行。</p>
<h2 id="3-RabbitMQ介绍"><a href="#3-RabbitMQ介绍" class="headerlink" title="3. RabbitMQ介绍"></a>3. RabbitMQ介绍</h2><h3 id="3-1-架构设计"><a href="#3-1-架构设计" class="headerlink" title="3.1 架构设计"></a>3.1 架构设计</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/RabbitMQ.svg" class="" title="design"><br />

<ul>
<li>Broker：服务节点，接收和分发消息的应用。</li>
<li>Exchange：交换机，生产者将消息发送到交换机，由交换机将消息路由到一个或多个队列中。如果路由不到，或返回给生产者，或直接丢弃，或做其他处理。</li>
<li>Queue：队列，是RabbitMQ的内部对象，用于存储消息。生产者投递消息到队列，消费者从队列中获取消息并消费。</li>
<li>RoutingKey：路由key，Exchange将消息发送到Queue的路由匹配规则。</li>
</ul>
<h3 id="3-2-其他概念"><a href="#3-2-其他概念" class="headerlink" title="3.2 其他概念"></a>3.2 其他概念</h3><ul>
<li>Vistual Host：虚拟主机，用于多用户和应用隔离。</li>
<li>Connection：publisher/consumer和broker之间的TCP连接。</li>
<li>Channel：如果每一次访问RabbitMQ都建立Connection，在消息量大的时候建立TCP Connection的开销将是巨大的，效率也较低。Channel是在Connection内部建立的逻辑连接，如果应用程序支持多线程，通常每个thread创建单独的Channel进行通讯。AMQP method包含了channel id帮助客户端和message broker和别channel，所以channel之间是完全隔离的。Channel作为轻量级的Connection极大地减少了操作系统建立TCP Conntection的开销。</li>
</ul>
<h3 id="3-3-交换机类型"><a href="#3-3-交换机类型" class="headerlink" title="3.3 交换机类型"></a>3.3 交换机类型</h3><p>RabbitMQ提供了三种交换机类型：</p>
<ol>
<li>Direct Exchange：直连交换机，根据RoutingKey精确匹配，消息会被投递到相应队列。</li>
<li>Fanout Exchange：广播交换机，发送消息时不需要声明RoutingKey，消息会被投递到与交换机绑定的所有队列。</li>
<li>Topic Exchange：主题交换机，根据RoutingKey模糊匹配，消息会被投递到相应队列。</li>
</ol>
<h2 id="4-RabbitMQ安装"><a href="#4-RabbitMQ安装" class="headerlink" title="4. RabbitMQ安装"></a>4. RabbitMQ安装</h2><div class="note icon simple"><i class="note-icon fab fa-kaggle"></i><p>安装原生的RabbitMQ需要erlang环境，懒得装了。</p>
</div>



<h3 id="4-1-docker安装"><a href="#4-1-docker安装" class="headerlink" title="4.1 docker安装"></a>4.1 docker安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">挂载目录</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> -p /home/rabbitmq/data</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动容器</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run -d --name rabbitmq \</span></span><br><span class="line"><span class="language-bash">-p 5672:5672 -p 15672:15672 \</span></span><br><span class="line"><span class="language-bash">-v /home/rabbitmq/data:/var/lib/rabbitmq \</span></span><br><span class="line"><span class="language-bash">-e RABBITMQ_DEFAULT_USER=Khighness \</span></span><br><span class="line"><span class="language-bash">-e RABBITMQ_DEFAULT_PASS=KAG1823 \</span></span><br><span class="line"><span class="language-bash">rabbitmq</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看插件</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rabbitmq-plugins list</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用|禁用插件</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rabbitmq-plugins <span class="built_in">enable</span> | <span class="built_in">disable</span> &lt;plugin&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="4-2-web管理"><a href="#4-2-web管理" class="headerlink" title="4.2 web管理"></a>4.2 web管理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">exec</span> -it rabbitmq bash</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</span></span><br></pre></td></tr></table></figure>

<p>登录用户名和密码即为<code>RABBITMQ_DEFAULT_USER</code>和<code>RABBITMQ_DEFAULT_PASS</code>。</p>
<h2 id="5-RabbitMQ消息模型"><a href="#5-RabbitMQ消息模型" class="headerlink" title="5. RabbitMQ消息模型"></a>5. RabbitMQ消息模型</h2><blockquote>
<p>官方文档：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/getstarted.html">https://www.rabbitmq.com/getstarted.html</a></p>
</blockquote>
<p>MQ准备：</p>
<p>创建用户（Username）<code>parak</code>，密码（Password）<code>123456</code>，创建虚拟主机（vistual hosts）<code>/learn</code>。</p>
<p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>日志配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">debug</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;LOG_HOME&quot;</span> <span class="attr">value</span>=<span class="string">&quot;log/&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>$&#123;LOG_HOME&#125;/rabbitmq.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">MaxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">MaxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">MaxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">MaxFileSize</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="5-1-Hello-World模型"><a href="#5-1-Hello-World模型" class="headerlink" title="5.1 Hello World模型"></a>5.1 Hello World模型</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/one.png" class="" title="one">

<br />

<p>在上图的模型中，有以下概念：</p>
<ul>
<li>P：生产者，也就是要发送消息的程序</li>
<li>C：消费者，消息的接受者，会一直等待消息到来</li>
<li>queue：消息队列，图中红色部分，生产者向其中投入消息，消费者在其中获取消息。</li>
</ul>
<p>构建连接工厂：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConnectionFactory connectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建MQ连接工厂</span></span><br><span class="line">    connectionFactory = <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">// 设置服务器IP:PORT</span></span><br><span class="line">    connectionFactory.setHost(<span class="string">&quot;192.168.117.155&quot;</span>);</span><br><span class="line">    connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">    <span class="comment">// 设置连接虚拟主机</span></span><br><span class="line">    connectionFactory.setVirtualHost(<span class="string">&quot;/learn&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置用户密码</span></span><br><span class="line">    connectionFactory.setUsername(<span class="string">&quot;parak&quot;</span>);</span><br><span class="line">    connectionFactory.setPassword(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生产消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testSendMessage</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">// 获取连接对象</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">    <span class="comment">// 获取连接通道</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">    <span class="comment">// 通道绑定消息队列</span></span><br><span class="line">    <span class="comment">// 参数1：队列名称，如果队列不存在则自动创建</span></span><br><span class="line">    <span class="comment">// 参数2：用来定义队列特性是否要持久化</span></span><br><span class="line">    <span class="comment">// 参数3：是否独占队列，只允许当前连接可用</span></span><br><span class="line">    <span class="comment">// 参数4：是否在消费完成后自动删除队列</span></span><br><span class="line">    <span class="comment">// 参数5：附加参数</span></span><br><span class="line">    channel.queueDeclare(<span class="string">&quot;hello&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// 发布消息</span></span><br><span class="line">    <span class="comment">// 参数1：交换机名称</span></span><br><span class="line">    <span class="comment">// 参数2：队列名称</span></span><br><span class="line">    <span class="comment">// 参数3：传递的额外设置</span></span><br><span class="line">    <span class="comment">// 参数4：消息的具体内容</span></span><br><span class="line">    channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;hello&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;hello, highness&quot;</span>.getBytes());</span><br><span class="line">    <span class="comment">// 关闭通道</span></span><br><span class="line">    channel.close();</span><br><span class="line">    <span class="comment">// 关闭连接</span></span><br><span class="line">    connection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testConsumeMessage</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">// 创建连接对象</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">    <span class="comment">// 创建连接通道</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">    <span class="comment">// 通道绑定队列</span></span><br><span class="line">    channel.queueDeclare(<span class="string">&quot;hello&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// 消费消息</span></span><br><span class="line">    <span class="comment">// 参数1：消费的队列名称</span></span><br><span class="line">    <span class="comment">// 参数2：开始消息的自动确认机制</span></span><br><span class="line">    <span class="comment">// 参数3：消费时的回调接口</span></span><br><span class="line">    channel.basicConsume(<span class="string">&quot;hello&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">        <span class="comment">// 参数1：标签</span></span><br><span class="line">        <span class="comment">// 参数2：信封</span></span><br><span class="line">        <span class="comment">// 参数3：属性</span></span><br><span class="line">        <span class="comment">// 参数4：消息队列中取出的消息</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;消费消息：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 需要不断接收队列中的消息，所以不关闭通道和连接</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>让队列和消息都持久化</p>
</blockquote>
<p><code>queueDeclare</code>方法的第二个参数需要设置为<code>true</code>；</p>
<p><code>basicPublish</code>方法的第三个参数需要设置为带<code>MessageProperties</code>的<code>PERSISTENT</code>的属性：</p>
<ul>
<li>MINIMAL_PERSISTENT_BASIC</li>
<li>PERSISTENT_BASIC</li>
<li>PERSISTENT_TEXT_PLAIN</li>
</ul>
<h3 id="5-2-Work-Queues模型"><a href="#5-2-Work-Queues模型" class="headerlink" title="5.2 Work Queues模型"></a>5.2 Work Queues模型</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/two.png" class="" title="two">

<br />

<p>Work Queues，任务模型。当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。此时就可以使用Work Queues：让多个消费者绑定到一个队列，共同消费消息队列中的消息。队列中的消息一旦消费，就会消失，因此任务是不会被重复执行的。</p>
<p>MQ准备：</p>
<ul>
<li>创建虚拟主机（vistual host）<code>/work</code></li>
</ul>
<p>MQ工厂：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQUtil</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HOST</span> <span class="operator">=</span> <span class="string">&quot;192.168.117.155&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">5672</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">VIRTUAL_HOST</span> <span class="operator">=</span> <span class="string">&quot;/learn&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USERNAME</span> <span class="operator">=</span> <span class="string">&quot;parak&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (connectionFactory == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (RabbitMQUtil.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (connectionFactory == <span class="literal">null</span>) &#123;</span><br><span class="line">                    connectionFactory = <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">                    connectionFactory.setHost(HOST);</span><br><span class="line">                    connectionFactory.setPort(PORT);</span><br><span class="line">                    connectionFactory.setVirtualHost(VIRTUAL_HOST);</span><br><span class="line">                    connectionFactory.setUsername(USERNAME);</span><br><span class="line">                    connectionFactory.setPassword(PASSWORD);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> connectionFactory.newConnection();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">closeConnectionAndChannel</span><span class="params">(Channel channel, Connection connection)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="literal">null</span>)</span><br><span class="line">                channel.close();</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="literal">null</span>)</span><br><span class="line">                connection.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模型演示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生产者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Provider</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;work&quot;</span>, MessageProperties.PERSISTENT_TEXT_PLAIN, <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;message&quot;</span> + (i + <span class="number">1</span>) + <span class="string">&quot; =&gt; hello, khighness&quot;</span>).getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">        RabbitMQUtil.closeConnectionAndChannel(channel, connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer1</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(Consumer1.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.basicConsume(<span class="string">&quot;work&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;消费者-1：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer2</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(Consumer2.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.basicConsume(<span class="string">&quot;work&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;消费者-2：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先运行消费者1和消费者2，最后运行生产者：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 消费者1</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">52.218</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG  top.parak.workqueue.Consumer1 - 消费者<span class="literal">-1</span>：message1 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">53.225</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG  top.parak.workqueue.Consumer1 - 消费者<span class="literal">-1</span>：message3 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">54.226</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG  top.parak.workqueue.Consumer1 - 消费者<span class="literal">-1</span>：message5 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">55.229</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG  top.parak.workqueue.Consumer1 - 消费者<span class="literal">-1</span>：message7 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">56.231</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">5</span>] DEBUG  top.parak.workqueue.Consumer1 - 消费者<span class="literal">-1</span>：message9 =&gt; hello, khighness</span><br><span class="line"><span class="comment"># 消费者2</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">52.219</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.workqueue.Consumer2 - 消费者<span class="literal">-2</span>：message2 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">52.221</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.workqueue.Consumer2 - 消费者<span class="literal">-2</span>：message4 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">52.221</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.workqueue.Consumer2 - 消费者<span class="literal">-2</span>：message6 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">52.221</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.workqueue.Consumer2 - 消费者<span class="literal">-2</span>：message8 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">52.222</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">5</span>] DEBUG top.parak.workqueue.Consumer2 - 消费者<span class="literal">-2</span>：message10 =&gt; hello, khighness</span><br></pre></td></tr></table></figure>

<p>总结：默认情况下，RabbitMQ按顺序将每个消息发送给下一个使用者。平均而言，每个消费者都会收到相同数量的消息，这种分发消息的方式成为循环。</p>
<p>上面的消息消费时是平均分配，那么如果需要修改的话，就要关闭消息自动确认机制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer1</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(Consumer1.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">// 一次只能消费一条消息</span></span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 第二个参数，关闭消息自动确认</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;work&quot;</span>, <span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;消费者-1：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                channel.basicAck(envelope.getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer2</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(Consumer2.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.basicConsume(<span class="string">&quot;work&quot;</span>, <span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;消费者-2：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">                channel.basicAck(envelope.getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新运行：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># consumer1</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">34.534</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.workqueue.Consumer1 - 消费者<span class="literal">-1</span>：message1 =&gt; hello, khighness</span><br><span class="line"></span><br><span class="line"><span class="comment"># consumer2</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.531</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.workqueue.Consumer2 - 消费者<span class="literal">-2</span>：message2 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.535</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">5</span>] DEBUG top.parak.workqueue.Consumer2 - 消费者<span class="literal">-2</span>：message3 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.536</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">6</span>] DEBUG top.parak.workqueue.Consumer2 - 消费者<span class="literal">-2</span>：message4 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.537</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">7</span>] DEBUG top.parak.workqueue.Consumer2 - 消费者<span class="literal">-2</span>：message5 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.538</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">8</span>] DEBUG top.parak.workqueue.Consumer2 - 消费者<span class="literal">-2</span>：message6 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.538</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">9</span>] DEBUG top.parak.workqueue.Consumer2 - 消费者<span class="literal">-2</span>：message7 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.539</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">10</span>] DEBUG top.parak.workqueue.Consumer2 - 消费者<span class="literal">-2</span>：message8 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.540</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">11</span>] DEBUG top.parak.workqueue.Consumer2 - 消费者<span class="literal">-2</span>：message9 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.541</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">12</span>] DEBUG top.parak.workqueue.Consumer2 - 消费者<span class="literal">-2</span>：message10 =&gt; hello, khighness</span><br></pre></td></tr></table></figure>



<h3 id="5-3-Publish-Subscribe模型"><a href="#5-3-Publish-Subscribe模型" class="headerlink" title="5.3 Publish/Subscribe模型"></a>5.3 Publish/Subscribe模型</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/three.png" class="" title="three">

<br />

<p>Publish/Subscribe模型，也称为Fanout模型，即发布-订阅模型或者广播模型。</p>
<p>流程：</p>
<ul>
<li>每个消费者都有自己的队列</li>
<li>每个队列都要绑定交换机</li>
<li>生产者发送的消息，只能发送到交换机，交换机来决定要发给哪个队列，生产者无法决定</li>
<li>交换机把消息发送到绑定过的所有队列</li>
<li>队列的消费者都能拿到消息，实现一条消息被多个消费者消费</li>
</ul>
<p>模型演示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生产者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Provider</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">// 指定交换机</span></span><br><span class="line">        <span class="comment">// 参数1：交换机名称，不存在则自动创建</span></span><br><span class="line">        <span class="comment">// 参数2：交换机类型</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;pubsub&quot;</span>, <span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">        <span class="comment">// 发送消息</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;pubsub&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;khighness&#x27;s message&quot;</span>.getBytes());</span><br><span class="line">        RabbitMQUtil.closeConnectionAndChannel(channel, connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者-1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer1</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(Consumer1.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">// 指定交换机</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;pubsub&quot;</span>, <span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">        <span class="comment">// 临时队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// 绑定交换机和队列</span></span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;pubsub&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// 消费消息</span></span><br><span class="line">        channel.basicConsume(queue, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                log.info(<span class="string">&quot;消费者-1：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者-2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer2</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(Consumer2.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">// 指定交换机</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;pubsub&quot;</span>, <span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">        <span class="comment">// 临时队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// 绑定交换机和队列</span></span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;pubsub&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// 消费消息</span></span><br><span class="line">        channel.basicConsume(queue, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                log.info(<span class="string">&quot;消费者-2：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先运行消费者1和消费者2，最后运行生产者：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 消费者1</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">21</span>:<span class="number">40</span>:<span class="number">58.365</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] INFO  top.parak.pubsub.Consumer1 - 消费者<span class="literal">-1</span>：khighness<span class="string">&#x27;s message</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 消费者2</span></span><br><span class="line"><span class="string">2021-05-24 21:40:58.365 [pool-1-thread-4] INFO  top.parak.pubsub.Consumer2 - 消费者-2：khighness&#x27;</span>s message</span><br></pre></td></tr></table></figure>



<h3 id="5-4-Routing模型"><a href="#5-4-Routing模型" class="headerlink" title="5.4 Routing模型"></a>5.4 Routing模型</h3><p>在Fanout模型中，一条消息会被所有订阅的队列都消费，但是，在某些场景下，我们希望不同的消息被不同的队列消费，这时就要用Routing的Direct类型的交换机。</p>
<p>在Direct模型中：</p>
<ul>
<li>队列与交换机的绑定，不能是任意绑定了，而是要指定一个RoutingKey。</li>
<li>消息的发送方在向Exchange发送消息时，也必须指定消息的RoutingKey。</li>
<li>Exchange不再把消息交给每一个绑定的队列，而是根据消息的RoutingKey进行判断，只有队列的RoutingKey与消息的RoutingKey完全一致，才会收到消息。</li>
</ul>
<p>图解：</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/four.png" class="" title="four">

<br />

<ul>
<li>P：生产者，向Exchange发送消息，发送消息时，会指定一个routing key</li>
<li>X：交换机，接收生产者的消息，然后把消息递交给与routing key完全匹配的队列</li>
<li>C1：消费者，其所在队列指定了需要routing key为error的消息</li>
<li>C2：消费者，其所在队列指定了需要routing key为info、error、warning的消息</li>
</ul>
<p>模型演示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生产者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Provider</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">// 指定交换机</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;routing&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="comment">// 发送消息</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;routing&quot;</span>, <span class="string">&quot;info&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;direct =&gt; info&quot;</span>.getBytes());</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;routing&quot;</span>, <span class="string">&quot;debug&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;direct =&gt; debug&quot;</span>.getBytes());</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;routing&quot;</span>, <span class="string">&quot;warn&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;direct =&gt; warn&quot;</span>.getBytes());</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;routing&quot;</span>, <span class="string">&quot;error&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;direct =&gt; error&quot;</span>.getBytes());</span><br><span class="line">        RabbitMQUtil.closeConnectionAndChannel(channel, connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer1</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(Consumer1.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">// 指定交换机</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;routing&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="comment">// 临时队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// 基于route key绑定队列和交换机</span></span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;routing&quot;</span>, <span class="string">&quot;info&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取消费的消息</span></span><br><span class="line">        channel.basicConsume(queue, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;消费者-1：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer2</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(Consumer2.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">// 指定交换机</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;routing&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="comment">// 临时队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// 基于route key绑定队列和交换机</span></span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;routing&quot;</span>, <span class="string">&quot;debug&quot;</span>);</span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;routing&quot;</span>, <span class="string">&quot;warn&quot;</span>);</span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;routing&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取消费的消息</span></span><br><span class="line">        channel.basicConsume(queue, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;消费者-2：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先运行消费者1和消费者2，最后运行生产者：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 消费者1</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">22</span>:<span class="number">47</span>:<span class="number">26.753</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.direct.Consumer1 - 消费者<span class="literal">-1</span>：direct =&gt; info</span><br><span class="line"></span><br><span class="line"><span class="comment"># 消费者2</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">22</span>:<span class="number">47</span>:<span class="number">26.753</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.direct.Consumer2 - 消费者<span class="literal">-2</span>：direct =&gt; debug</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">22</span>:<span class="number">47</span>:<span class="number">26.756</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.direct.Consumer2 - 消费者<span class="literal">-2</span>：direct =&gt; warn</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">22</span>:<span class="number">47</span>:<span class="number">26.756</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.direct.Consumer2 - 消费者<span class="literal">-2</span>：direct =&gt; error</span><br></pre></td></tr></table></figure>



<h3 id="5-5-Topics模型"><a href="#5-5-Topics模型" class="headerlink" title="5.5 Topics模型"></a>5.5 Topics模型</h3><p>Topics模型与Direct模型相比，都是可以根据RoutingKey把消息路由到不同的队列，只不过Topic类型Exchange可以让队列在绑定RoutingKey的时候使用通配符。</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/five.png" class="" title="five">

<br />

<p>Topics模型的RoutingKey是由一个或者多个单词组成，多个单词之间以<code>.</code>分隔，有两种通配符：</p>
<ul>
<li><code>*</code>：匹配一个单词</li>
<li><code>#</code>：匹配多个单词</li>
</ul>
<p>模型演示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生产者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Provider</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;topics&quot;</span>, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;topics&quot;</span>, <span class="string">&quot;k.a&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;topics =&gt; k.a&quot;</span>.getBytes());</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;topics&quot;</span>, <span class="string">&quot;k.a.g&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;topics =&gt; k.a.g&quot;</span>.getBytes());</span><br><span class="line">        RabbitMQUtil.closeConnectionAndChannel(channel, connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer2</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(Consumer2.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;topics&quot;</span>, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">queue</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;topics&quot;</span>, <span class="string">&quot;k.#&quot;</span>);</span><br><span class="line">        channel.basicConsume(queue, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;消费者-2：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    	<span class="comment">// 临时队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// 基于route key绑定队列和交换机</span></span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;routing&quot;</span>, <span class="string">&quot;debug&quot;</span>);</span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;routing&quot;</span>, <span class="string">&quot;warn&quot;</span>);</span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;routing&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取消费的消息</span></span><br><span class="line">        channel.basicConsume(queue, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;消费者-2：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先运行消费者1和消费者2，最后运行生产者：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 消费者1</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">23</span>:<span class="number">14</span>:<span class="number">53.574</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.topics.Consumer1 - 消费者<span class="literal">-1</span>：topics =&gt; k.a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 消费者2</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">23</span>:<span class="number">14</span>:<span class="number">53.573</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.topics.Consumer2 - 消费者<span class="literal">-2</span>：topics =&gt; k.a</span><br><span class="line"><span class="number">2021</span><span class="literal">-05-24</span> <span class="number">23</span>:<span class="number">14</span>:<span class="number">53.578</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.topics.Consumer2 - 消费者<span class="literal">-2</span>：topics =&gt; k.a.g</span><br></pre></td></tr></table></figure>



<h2 id="6-RabbitMQ整合SpringBoot"><a href="#6-RabbitMQ整合SpringBoot" class="headerlink" title="6. RabbitMQ整合SpringBoot"></a>6. RabbitMQ整合SpringBoot</h2><div class="note icon simple"><i class="note-icon fab fa-korvue"></i><p>在使用SpringBoot的AMQP API之前，一定要理解消息的处理顺序：</p>
<p>生产的消息先到达交换机，然后经过routingKey匹配，到达绑定的队列中，等待消费。</p>
<p>我们使用SpringBoot整合RabbitMQ的过程中，一般顺序如下：</p>
<ol>
<li>在配置类中注册相应的交换机、队列，同时通过路由进行绑定；</li>
<li>编写消息生产者，生产者发送消息时需要填入参数：交换机、路由和消息；</li>
<li>编写消息消费者，消费者需要监听相应的队列。</li>
</ol>
</div>



<p>创建项目，引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring.boot.version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">spring.boot.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>项目配置<code>application.properties</code>：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">3333</span></span><br><span class="line"><span class="attr">spring.application.name</span>=<span class="string">springboot-rabbitmq</span></span><br><span class="line"><span class="attr">spring.rabbitmq.host</span>=<span class="string">192.168.117.155</span></span><br><span class="line"><span class="attr">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="attr">spring.rabbitmq.virtual-host</span>=<span class="string">/learn</span></span><br><span class="line"><span class="attr">spring.rabbitmq.username</span>=<span class="string">parak</span></span><br><span class="line"><span class="attr">spring.rabbitmq.password</span>=<span class="string">KAG1823</span></span><br></pre></td></tr></table></figure>



<h3 id="6-1-配置类"><a href="#6-1-配置类" class="headerlink" title="6.1 配置类"></a>6.1 配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DIRECT_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;parak.exchange.direct&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FANOUT_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;parak.exchange.fanout&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOPIC_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;parak.exchange.topic&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HEADER_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;parak.exchange.header&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HELLO_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;parak.queue.hello&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WORK_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;parak.queue.work1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DIRECT_QUEUE1</span> <span class="operator">=</span> <span class="string">&quot;parak.queue.direct1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DIRECT_QUEUE2</span> <span class="operator">=</span> <span class="string">&quot;parak.queue.direct2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FANOUT_QUEUE1</span> <span class="operator">=</span> <span class="string">&quot;parak.queue.fanout1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FANOUT_QUEUE2</span> <span class="operator">=</span> <span class="string">&quot;parak.queue.fanout2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOPIC_QUEUE1</span> <span class="operator">=</span> <span class="string">&quot;parak.queue.topic1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOPIC_QUEUE2</span> <span class="operator">=</span> <span class="string">&quot;parak.queue.topic2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HEADER_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;parak.queue.header&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HELLO_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WORK_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;work&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DIRECT_ROUTING_KEY1</span> <span class="operator">=</span> <span class="string">&quot;k&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DIRECT_ROUTING_KEY2</span> <span class="operator">=</span> <span class="string">&quot;a&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOPIC_ROUTING_KEY1</span> <span class="operator">=</span> <span class="string">&quot;k.a.*&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOPIC_ROUTING_KEY2</span> <span class="operator">=</span> <span class="string">&quot;k.a.#&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. Direct Exchange：直连交换机，精确匹配路由，推送到相应队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;directExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">directExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(DIRECT_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;helloQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">helloQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(HELLO_QUEUE, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;workQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">workQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(WORK_QUEUE, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;directQueue1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">directQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DIRECT_QUEUE1, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;directQueue2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">directQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DIRECT_QUEUE2, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">directBinding1</span><span class="params">(<span class="meta">@Qualifier(&quot;helloQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;directExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(HELLO_ROUTING_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">directBinding2</span><span class="params">(<span class="meta">@Qualifier(&quot;workQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;directExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(WORK_ROUTING_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">directBinding3</span><span class="params">(<span class="meta">@Qualifier(&quot;directQueue1&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;directExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DIRECT_ROUTING_KEY1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">directBinding4</span><span class="params">(<span class="meta">@Qualifier(&quot;directQueue2&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;directExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DIRECT_ROUTING_KEY2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 2. Fanout Exchange: 广播交换机，不需要路由，发送到所有绑定过的队列队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;fanoutExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">fanoutExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(FANOUT_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;fanoutQueue1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">fanoutQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(FANOUT_QUEUE1, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;fanoutQueue2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">fanoutQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(FANOUT_QUEUE2, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">fanoutBinding1</span><span class="params">(<span class="meta">@Qualifier(&quot;fanoutQueue1&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;fanoutExchange&quot;)</span> FanoutExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">fanoutBinding2</span><span class="params">(<span class="meta">@Qualifier(&quot;fanoutQueue2&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;fanoutExchange&quot;)</span> FanoutExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 3. Topic Exchange：主题交换机，模糊匹配路由，推送到相应队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;topicExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> TopicExchange <span class="title function_">topicExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TopicExchange</span>(TOPIC_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;topicQueue1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">topicQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(TOPIC_QUEUE1, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;topicQueue2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">topicQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(TOPIC_QUEUE2, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">topicBinding1</span><span class="params">(<span class="meta">@Qualifier(&quot;topicQueue1&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;topicExchange&quot;)</span> TopicExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(topicExchange()).with(TOPIC_ROUTING_KEY1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">topicBinding2</span><span class="params">(<span class="meta">@Qualifier(&quot;topicQueue2&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;topicExchange&quot;)</span> TopicExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(topicQueue2()).to(topicExchange()).with(TOPIC_ROUTING_KEY2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 4. Header Exchange: 头部交换机，根据header匹配，推送到相应队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;headersExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> HeadersExchange <span class="title function_">headersExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HeadersExchange</span>(HEADER_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;headerQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">headerQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(HEADER_QUEUE, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">headerBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;headerQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;headersExchange&quot;)</span> HeadersExchange exchange)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;signature&quot;</span>, <span class="string">&quot;Khighness&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).whereAny(map).match();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="6-2-生产者"><a href="#6-2-生产者" class="headerlink" title="6.2 生产者"></a>6.2 生产者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.AmqpTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessageProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rabbitmq/send&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AmqpTemplate amqpTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 双端模型, 使用routing名称匹配queue名称，默认相等匹配</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/hello?msg=Khighness&quot;&gt;hello&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">     <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sendHello</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> &#123;</span><br><span class="line">        amqpTemplate.convertAndSend(RabbitMQConfig.DIRECT_EXCHANGE, RabbitMQConfig.HELLO_ROUTING_KEY, message);</span><br><span class="line">        log.info(<span class="string">&quot;『Hello』 send message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 工作模型，多消费者，消费者轮询消费</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/work?msg=Khighness&quot;&gt;work&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/work&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sendWork</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> &#123;</span><br><span class="line">        amqpTemplate.convertAndSend(RabbitMQConfig.DIRECT_EXCHANGE, RabbitMQConfig.WORK_ROUTING_KEY, message);</span><br><span class="line">        log.info(<span class="string">&quot;『Work』 send message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由模型，根据routingKey精确匹配，routingKey未匹配的消息会丢失</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/direct?key=k&amp;msg=Khighness&quot;&gt;k&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/direct?key=a&amp;msg=Khighness&quot;&gt;a&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/direct&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sendDirect</span><span class="params">(<span class="meta">@RequestParam(&quot;key&quot;)</span> String routingKey, <span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> &#123;</span><br><span class="line">        amqpTemplate.convertAndSend(RabbitMQConfig.DIRECT_EXCHANGE, routingKey, message);</span><br><span class="line">        log.info(<span class="string">&quot;『Direct』 send message: [&#123;&#125;], with key: [&#123;&#125;]&quot;</span>, message, routingKey);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 广播模型，不需要routingKey，消息推送到交换机绑定的所有队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/fanout?msg=Khighness&quot;&gt;fanout&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/fanout&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sendFanout</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> &#123;</span><br><span class="line">        amqpTemplate.convertAndSend(RabbitMQConfig.FANOUT_EXCHANGE, RabbitMQConfig.DEFAULT_ROUTING_KEY, message);</span><br><span class="line">        log.info(<span class="string">&quot;『Fanout』 send message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主题模型，根据routingKey模糊匹配，推送到相应队列，routingKey未匹配的消息会丢失</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/topic?key=k.a.g&amp;msg=Khighness&quot;&gt;k.a.g&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/topic?key=k.a.g.c&amp;msg=Khighness&quot;&gt;k.a.g.c&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/topic&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sendTopic</span><span class="params">(<span class="meta">@RequestParam(&quot;key&quot;)</span> String routingKey, <span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> &#123;</span><br><span class="line">        amqpTemplate.convertAndSend(RabbitMQConfig.TOPIC_EXCHANGE, routingKey, message);</span><br><span class="line">        log.info(<span class="string">&quot;『Topic』 send message: [&#123;&#125;], with key: [&#123;&#125;]&quot;</span>, message, routingKey);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 头部模型，不需要routingKey，根据header字段匹配，未匹配的消息会丢失</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/header?sign=Khighness&amp;msg=Khighness&quot;&gt;Khighness&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/header?sign=follwerK&amp;msg=Khighness&quot;&gt;flowerK&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/header&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sendHeader</span><span class="params">(<span class="meta">@RequestParam(&quot;sign&quot;)</span> String signature, <span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> &#123;</span><br><span class="line">        <span class="type">MessageProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageProperties</span>();</span><br><span class="line">        properties.setHeader(<span class="string">&quot;signature&quot;</span>, signature);</span><br><span class="line">        <span class="type">Message</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(message.getBytes(), properties);</span><br><span class="line">        amqpTemplate.convertAndSend(RabbitMQConfig.HEADER_EXCHANGE, RabbitMQConfig.DEFAULT_ROUTING_KEY, obj);</span><br><span class="line">        log.info(<span class="string">&quot;『Header』 send message: [&#123;&#125;], with sign: [&#123;&#125;]&quot;</span>, message, signature);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="6-3-消费者"><a href="#6-3-消费者" class="headerlink" title="6.3 消费者"></a>6.3 消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.HELLO_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveHello</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『Hello』 receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.WORK_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveWork1</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『Work-1』 receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.WORK_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveWork2</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『Work-2』 receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.DIRECT_QUEUE1)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveDirect1</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『Direct-1』 receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.DIRECT_QUEUE1)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveDirect2</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『Direct-2』 receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.FANOUT_QUEUE1)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveFanout1</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『Fanout-1』 receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.FANOUT_QUEUE2)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveFanout2</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『Fanout-2』 receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.TOPIC_QUEUE1)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveTopic1</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『Topic-1』 receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.TOPIC_QUEUE2)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveTopic2</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『Topic-2』 receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.HEADER_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveHeader</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『Header』 receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-4-启动类"><a href="#6-4-启动类" class="headerlink" title="6.4 启动类"></a>6.4 启动类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(RabbitMQApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="7-RabbitMQ死信队列"><a href="#7-RabbitMQ死信队列" class="headerlink" title="7. RabbitMQ死信队列"></a>7. RabbitMQ死信队列</h2><h3 id="7-1-死信队列"><a href="#7-1-死信队列" class="headerlink" title="7.1 死信队列"></a>7.1 死信队列</h3><p>消费消息时，如果出现以下情况，：</p>
<ol>
<li>消息被否定确认，使用<code>channel.basicNack</code>或者<code>channel.basicReject</code>，并且此时<code>requeue</code>被设置为<code>false</code>。</li>
<li>消息在队列的存活时间超过设置的TTL时间。</li>
<li>消息队列的消息数量已经超过最大队列长度。</li>
</ol>
<p>那么消息被称为死信（Dead Letter）。</p>
<h3 id="7-2-实现原理"><a href="#7-2-实现原理" class="headerlink" title="7.2 实现原理"></a>7.2 实现原理</h3><p>步骤：</p>
<ol>
<li>声明业务交换机，配置业务路由，绑定业务队列；</li>
<li>声明死信交换机，配置死信路由，绑定死信队列；</li>
<li>为业务队列绑定死信路由和死信交换机。</li>
</ol>
<p>一个项目声明一个死信交换机即可，可以为任意类型【Direct、Fanout、Topic】绑定多个业务队列，为每个业务队列分配一个单独的路由key。</p>
<h3 id="7-3-具体编码"><a href="#7-3-具体编码" class="headerlink" title="7.3 具体编码"></a>7.3 具体编码</h3><p>创建项目，引入依赖。</p>
<p>项目配置<code>application.properties</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.port=5555</span></span><br><span class="line"><span class="string">spring.application.name=springboot-deadletter</span></span><br><span class="line"><span class="string">spring.rabbitmq.host=192.168.117.155</span></span><br><span class="line"><span class="string">spring.rabbitmq.port=5672</span></span><br><span class="line"><span class="string">spring.rabbitmq.virtual-host=/learn</span></span><br><span class="line"><span class="string">spring.rabbitmq.username=parak</span></span><br><span class="line"><span class="string">spring.rabbitmq.password=KAG1823</span></span><br><span class="line"><span class="string">spring.rabbitmq.listener.simple.default-requeue-rejected=false</span></span><br><span class="line"><span class="string">spring.rabbitmq.listener.simple.acknowledge-mode=manual</span></span><br></pre></td></tr></table></figure>

<p>创建配置类<code>DeadLetterConfig</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;parak.dead.letter.business.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_QUEUE1</span> <span class="operator">=</span> <span class="string">&quot;parak.dead.letter.business.queue1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_QUEUE2</span> <span class="operator">=</span> <span class="string">&quot;parak.dead.letter.business.queue2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;parak.dead.letter.death.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_QUEUE1</span> <span class="operator">=</span> <span class="string">&quot;parak.dead.letter.death.queue1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_QUEUE2</span> <span class="operator">=</span> <span class="string">&quot;parak.dead.letter.death.queue2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_ROUTING_KEY1</span> <span class="operator">=</span> <span class="string">&quot;parak.dead.letter.death.key1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_ROUTING_KEY2</span> <span class="operator">=</span> <span class="string">&quot;parak.dead.letter.death.key2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明业务交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;businessExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">businessExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(BUSINESS_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;businessQueue1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">businessQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// x-dead-letter-exchange 声明当前队列绑定的死信交换机</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_LETTER_EXCHANGE);</span><br><span class="line">        <span class="comment">// x-dead-letter-routing-key 声明当前队列的死信路由key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_LETTER_ROUTING_KEY1);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_QUEUE1).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;businessQueue2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">businessQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// x-dead-letter-exchange 声明当前队列绑定的死信交换机</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_LETTER_EXCHANGE);</span><br><span class="line">        <span class="comment">// x-dead-letter-routing-key 声明当前队列的死信路由key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_LETTER_ROUTING_KEY2);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_QUEUE2).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">businessBinding1</span><span class="params">(<span class="meta">@Qualifier(&quot;businessQueue1&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;businessExchange&quot;)</span> FanoutExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">businessBinding2</span><span class="params">(<span class="meta">@Qualifier(&quot;businessQueue2&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;businessExchange&quot;)</span> FanoutExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明死信交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;deadLetterExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">deadLetterExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(DEAD_LETTER_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;deadLetterQueue1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">deadLetterQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DEAD_LETTER_QUEUE1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;deadLetterQueue2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">deadLetterQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DEAD_LETTER_QUEUE2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">deadLetterBinding1</span><span class="params">(<span class="meta">@Qualifier(&quot;deadLetterQueue1&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;deadLetterExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DEAD_LETTER_ROUTING_KEY1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">deadLetterBinding2</span><span class="params">(<span class="meta">@Qualifier(&quot;deadLetterQueue2&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;deadLetterExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DEAD_LETTER_ROUTING_KEY1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述类中配置了两个交换机：</p>
<ul>
<li>业务交换机</li>
<li>死信交换机</li>
</ul>
<p>并且分别为两个交换机绑定了两个队列。</p>
<p>创建业务消息的消费者<code>BusinessMessageReceiver</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessMessageReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DeadLetterConfig.BUSINESS_QUEUE1)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveBusiness1</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">        log.info(<span class="string">&quot;『business-1』 receive message: [&#123;&#125;]&quot;</span>, msg);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">ack</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">Exception</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (msg.contains(<span class="string">&quot;dead-letter&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Dead Letter&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            ack = <span class="literal">false</span>;</span><br><span class="line">            exception = e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!ack) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;consume message occur exception: [&#123;&#125;]&quot;</span>, exception.getMessage(), exception);</span><br><span class="line">            channel.basicNack(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DeadLetterConfig.BUSINESS_QUEUE2)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reveiveBusiness2</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『business-2』 receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建死信消息的消费者<code>DeadLetterMessageReceiver</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterMessageReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DeadLetterConfig.DEAD_LETTER_QUEUE1)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveDeadLetter1</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『dead letter-1』 receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DeadLetterConfig.DEAD_LETTER_QUEUE2)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveDeadLetter2</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『dead letter-2』 receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>封装业务消息发送者<code>BusinessMessageSender</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> top.parak.rabbitmq.RabbitMQConfig;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessMessageSender</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(DeadLetterConfig.BUSINESS_EXCHANGE, RabbitMQConfig.DEFAULT_ROUTING_KEY, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建接口用于生产消息<code>MessageController</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rabbitmq/send&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BusinessMessageSender businessMessageSender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送延时消息，按照类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=1&quot;&gt;delay 3s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=2&quot;&gt;delay 10s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/delay&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String message, <span class="meta">@RequestParam(&quot;type&quot;)</span> Integer type)</span> &#123;</span><br><span class="line">        <span class="type">DelayType</span> <span class="variable">delayType</span> <span class="operator">=</span> DelayType.getDelayType(type);</span><br><span class="line">        <span class="keyword">if</span> (delayType == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;type is in [1, 2]&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;now: [&#123;&#125;], receive message: [&#123;&#125;], type: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), message, delayType);</span><br><span class="line">        delayMessageSender.sendMsg(message, delayType);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写启动类并运行，访问浏览器进行测试：</p>
<p>（1）访问：<a target="_blank" rel="noopener" href="http://localhost:5555/rabbitmq/send/dead?msg=khighness">http://localhost:5555/rabbitmq/send/dead?msg=khighness</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09-19</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">58.857</span>  INFO <span class="number">10120</span> <span class="literal">---</span> [<span class="type">ntContainer</span><span class="comment">#9-1] top.parak.death.BusinessMessageReceiver  : 『business-2』 receive message: [khighness]</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">19</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">58.858</span>  <span class="type">INFO</span> <span class="number">10120</span> --- [<span class="type">tContainer</span><span class="comment">#10-1] top.parak.death.BusinessMessageReceiver  : 『business-1』 receive message: [khighness]</span></span><br></pre></td></tr></table></figure>

<p>（2）访问：<a target="_blank" rel="noopener" href="http://localhost:5555/rabbitmq/send/dead?msg=dead-letter-kkk">http://localhost:5555/rabbitmq/send/dead?msg=dead-letter-kkk</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09-19</span> <span class="number">21</span>:<span class="number">07</span>:<span class="number">23.462</span>  INFO <span class="number">10120</span> <span class="literal">---</span> [<span class="type">ntContainer</span><span class="comment">#9-1] top.parak.death.BusinessMessageReceiver  : 『business-2』 receive message: [dead-letter]</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">07</span>:<span class="number">23.462</span>  <span class="type">INFO</span> <span class="number">10120</span> --- [<span class="type">tContainer</span><span class="comment">#10-1] top.parak.death.BusinessMessageReceiver  : 『business-1』 receive message: [dead-letter]</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">07</span>:<span class="number">23.462</span> <span class="type">ERROR</span> <span class="number">10120</span> --- [<span class="type">tContainer</span><span class="comment">#10-1] top.parak.death.BusinessMessageReceiver  : consumer message occur exception: [Dead Letter]</span></span><br><span class="line"></span><br><span class="line"><span class="type">java.lang.RuntimeException</span>: <span class="type">Dead</span> <span class="type">Letter</span></span><br><span class="line"><span class="type">...</span></span><br><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">07</span>:<span class="number">23.465</span>  <span class="type">INFO</span> <span class="number">10120</span> --- [<span class="type">tContainer</span><span class="comment">#12-1] t.parak.death.DeadLetterMessageReceiver  : 『dead letter-1』 receive message: [dead-letter]</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">07</span>:<span class="number">23.465</span>  <span class="type">INFO</span> <span class="number">10120</span> --- [<span class="type">tContainer</span><span class="comment">#11-1] t.parak.death.DeadLetterMessageReceiver  : 『dead letter-2』 receive message: [dead-letter]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="7-4-消息变化"><a href="#7-4-消息变化" class="headerlink" title="7.4 消息变化"></a>7.4 消息变化</h3><p>死信消息被丢到死信队列，会发生什么变化呢？</p>
<p>如果队列配置了参数<code>x-dead-letter-routing-key</code>的话，死信的路由key将会被替换成该参数对应的值。如果没有配置，则保留该消息原有的路由key。</p>
<p>举个🌰：</p>
<p>如果原有消息的路由key是<code>K</code>，被发送到业务交换机中，然后被投递到业务队列<code>Queue1</code>中，如果该队列没有配置参数<code>x-dead-letter-routing-key</code>，则该消息成为死信后，将保留原有的路由key<code>K</code>，如果配置了该参数，并且值设置为<code>A</code>，那么该消息成为死信后，路由key会被替换为<code>A</code>，然后被抛到死信交换机中。</p>
<p>另外，由于被抛到了死信交换机，所以消息的交换机名称也会被替换为死信交换机的名称。</p>
<p>而消息的Header中，也会添加很多奇奇怪怪的字段，修改死信队列的消费者代码，添加一行日志输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log.info(&quot;dead letter properties: [&#123;&#125;]&quot;, message.getMessageProperties());</span><br></pre></td></tr></table></figure>

<p>再次测试，可以得到死信消息Header中被添加的信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2021-09-19 21:53:41.172  INFO 5628 --- [tContainer#12-1] t.parak.death.DeadLetterMessageReceiver  : dead letter properties: [MessageProperties [headers=&#123;x-first-death-exchange=parak.dead.letter.business.exchange, x-death=[&#123;reason=rejected, count=1, exchange=parak.dead.letter.business.exchange, time=Sun Sep 19 21:09:38 CST 2021, routing-keys=[], queue=parak.dead.letter.business.queue1&#125;], x-first-death-reason=rejected, x-first-death-queue=parak.dead.letter.business.queue1&#125;, contentType=text/plain, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=parak.dead.letter.death.exchange, receivedRoutingKey=parak.dead.letter.death.key1, deliveryTag=1, consumerTag=amq.ctag-DmBuSjljWVkbuaFJvspHyw, consumerQueue=parak.dead.letter.death.queue1]]</span><br></pre></td></tr></table></figure>

<p>简要说明一下Header中的值：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>x-first-death-exchange</td>
<td>第一次被抛入的死信交换机的名称</td>
</tr>
<tr>
<td>x-first-death-reason</td>
<td>第一次成为死信的原因：<br />(1)<code>rejected</code>：消息在重新进入队列时被队列拒绝，由于<code>default-requeue-rejected</code>参数被设置为<code>false</code><br />(2)<code>expired</code>：消息过期<br />(3)<code>maxlen</code>：队列内消息数量超过队列最大容量</td>
</tr>
<tr>
<td>x-first-death-queue</td>
<td>第一次称为死信前所在队列名称</td>
</tr>
<tr>
<td>x-death</td>
<td>历次被投入死信交换机的信息列表，同一个消息每次进入一个死信交换机，这个数组的信息就会被更新。</td>
</tr>
</tbody></table>
<h3 id="7-5-应用场景"><a href="#7-5-应用场景" class="headerlink" title="7.5 应用场景"></a>7.5 应用场景</h3><p>一般用在较为重要的业务队列中，确保未被正确消费的消息不被丢弃，一般发生消费异常可能原因主要有由于消息信息本身存在消息错误导致处理异常、处理过程中参数校验异常或者因网络波动导致的查询异常等等。当发生异常时，当然不能每次通过日志来获取原消息，然后让运维帮忙重新投递消息。</p>
<p>通过配置死信队列，可以让未正确处理的消息暂存到另一个队列中，待后续排查清除问题后，编写相应的处理代码来处理死信消息，这样比手工恢复数据好太多了。</p>
<h3 id="7-6-生命周期"><a href="#7-6-生命周期" class="headerlink" title="7.6 生命周期"></a>7.6 生命周期</h3><p>总结一下死信消息的生命周期：</p>
<ol>
<li>业务消息被投入业务队列；</li>
<li>消费者消费业务队列的消息，由于处理过程中产生了异常，于是进行nack或者reject操作；</li>
<li>被nack或reject的消息由RabbitMQ投递到死信交换机中；</li>
<li>死信交换机将消息投递到相应的死信队列中；</li>
<li>死信队列的消费者消费死信消息。</li>
</ol>
<p>死信队列并没有特殊的地方，不过是绑定在死信交换机上的普通队列，而死信交换机也只是一个普通的交换机，只不过专门用于处理死信。</p>
<h2 id="8-RabbitMQ延时队列"><a href="#8-RabbitMQ延时队列" class="headerlink" title="8. RabbitMQ延时队列"></a>8. RabbitMQ延时队列</h2><h3 id="8-1-延时队列"><a href="#8-1-延时队列" class="headerlink" title="8.1 延时队列"></a>8.1 延时队列</h3><p>延时队列：队列内部元素有序，并且每个元素带时间属性。</p>
<p>元素需要在指定时间被取出和处理，通常来说是消息或任务。</p>
<h3 id="8-2-使用场景"><a href="#8-2-使用场景" class="headerlink" title="8.2 使用场景"></a>8.2 使用场景</h3><p>考虑以下场景：</p>
<ul>
<li>用户下单后，订单十分钟内未支付则自动取消；</li>
<li>用户注册成功后，三天未登录则进行短信提醒；</li>
<li>预定会议后，预约时间前十分钟通知人员参会。</li>
</ul>
<p>这些场景都有一个特点，需要在某个事件发生之后或者之前的指定时间点内完成某一项任务，如：发生订单生成事件，在十分钟之后检查该订单支付状态，然后将未支付的订单进行关闭；发生用户注册事件，三天后检查新注册用户的活动数据，然后通知没有任何活动记录的用户。</p>
<p>以上场景很容易想到使用定时任务+轮询解决，一直轮询数据，每秒查询一次，取出需要被处理的数据。每天晚上跑个定时任务检查所有未支付的订单，在数据量比较少的情况这么做没有太大的毛病。但是对于数据量比较大，并且时效性较强的场景，比如：秒杀场景下订单十分钟未支付则关闭，在活动期间的订单数据量庞大的情况下进行去轮询数据库，很可能在一秒内无法完成所有订单的检查，同时会给数据库带来巨大的压力，无法满足业务要求并且性能低下。</p>
<p>而将延时队列应用到上述场景，保证性能的同时还能保持优雅。</p>
<h3 id="8-3-RabbitMQ-TTL"><a href="#8-3-RabbitMQ-TTL" class="headerlink" title="8.3 RabbitMQ-TTL"></a>8.3 RabbitMQ-TTL</h3><p>这里需要介绍一下RabbitMQ的高级特性：<code>TTL</code>(Time to Live)。</p>
<p>TTL是RabbitMQ中一个消息或者队列的属性，表明一条消息或者该队列中的所有消息的最大存活时间，单位是毫秒。换句话说，如果一条消息设置了TTL属性或者进入了设置TTL属性的队列，那么这条消息如果在TTL设置的时间内没有被消费，则会成为“死信”。如果同时配置了队列的TTL和消息的TTL，那么较小的那个值将会被使用。</p>
<p>设置TTL属性有两种方式：</p>
<p>（1）创建队列的时候设置队列的<code>x-message-ttl</code>属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">args.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">6000</span>);</span><br><span class="line">channel.queueDeclare(queueName, durable, exclusive, autoDelete, args);</span><br></pre></td></tr></table></figure>

<p>这样所有被投递到该队列的消息都最多不会存活超过6s。</p>
<p>（2）针对每条消息设置TTL最大存活时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AMQP.BasicProperties.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties.Builder();</span><br><span class="line">builder.expiration(<span class="string">&quot;6000&quot;</span>);</span><br><span class="line">AMQP.<span class="type">BasicProperties</span> <span class="variable">properties</span> <span class="operator">=</span> builder.build();</span><br><span class="line">channel.basicPublish(exchangeName, routingKey, mandatory, properties, message.getBytes());</span><br></pre></td></tr></table></figure>

<p>但是这两种方式还是区别的，如果设置了队列的TTL属性，那么消息一旦过期，就会被队列丢弃，而第二种方式，消息即使过期，也不一定会被马上丢弃，因为消息是否过期是在即将投递到消费者之前判定的，如果当前队列有严重的消息积压情况，则已过期的消息也许还能存活较长时间。</p>
<p>另外，还需要注意：</p>
<ul>
<li>如果不设置TTL，表示消息永远不会过期。</li>
<li>如果设置TTL=0，则表示除非此时可以直接投递该消息到消费者，否则该消息将会被丢弃。</li>
</ul>
<h3 id="8-4-实现原理"><a href="#8-4-实现原理" class="headerlink" title="8.4 实现原理"></a>8.4 实现原理</h3><p>延时队列，即将消息延迟一定时间进行处理，TTL刚好能让消息在延迟一定时间成为死信，另一方面，成为死信的消息都会被投递到死信队列中，这样只需要消费者一直消费死信队列中的消息即可。</p>
<p>消息流向如下：</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/delay.png" class="" title="delay"><br />

<p>生产者生产一条延时消息，根据需要延时时间的不同，利用不同的routingKey将消息路由到不同的延时队列，每个队列都设置了不同的TTL属性，并绑定在同一个死信交换机中，消息过期后，根据routingKey的不同，又会被路由到不同的死信队列中，消费者只需要监听对应的死信队列进行处理即可。</p>
<h3 id="8-5-具体编码"><a href="#8-5-具体编码" class="headerlink" title="8.5 具体编码"></a>8.5 具体编码</h3><p>创建项目，引入依赖。</p>
<p>项目配置<code>application.properties</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.port=6666</span></span><br><span class="line"><span class="string">spring.application.name=springboot-delayqueue</span></span><br><span class="line"><span class="string">spring.rabbitmq.host=192.168.117.155</span></span><br><span class="line"><span class="string">spring.rabbitmq.port=5672</span></span><br><span class="line"><span class="string">spring.rabbitmq.virtual-host=/learn</span></span><br><span class="line"><span class="string">spring.rabbitmq.username=parak</span></span><br><span class="line"><span class="string">spring.rabbitmq.password=KAG1823</span></span><br><span class="line"><span class="string">spring.rabbitmq.listener.simple.default-requeue-rejected=false</span></span><br><span class="line"><span class="string">spring.rabbitmq.listener.simple.acknowledge-mode=manual</span></span><br></pre></td></tr></table></figure>

<p>编写配置类<code>DelayQueueConfig</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayQueueConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.business.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_QUEUE1</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.business.queue1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_QUEUE2</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.business.queue2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_QUEUE_ROUTING_KEY1</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.business.key1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_QUEUE_ROUTING_KEY2</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.business.key2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.deadletter.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_QUEUE1</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.deadletter.queue1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_QUEUE2</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.deadletter.queue2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_ROUTING_KEY1</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.deadletter.key1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_ROUTING_KEY2</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.deadletter.key2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明延时交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;delayExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">delayExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(DELAY_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;delayQueue1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_LETTER_EXCHANGE);</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_LETTER_ROUTING_KEY1);</span><br><span class="line">        map.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">3000</span>);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(DELAY_QUEUE1).withArguments(map).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;delayQueue2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_LETTER_EXCHANGE);</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_LETTER_ROUTING_KEY2);</span><br><span class="line">        map.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">10000</span>);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(DELAY_QUEUE2).withArguments(map).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">delayBinding1</span><span class="params">(<span class="meta">@Qualifier(&quot;delayQueue1&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;delayExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DELAY_QUEUE_ROUTING_KEY1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">delayBinding2</span><span class="params">(<span class="meta">@Qualifier(&quot;delayQueue2&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;delayExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DELAY_QUEUE_ROUTING_KEY2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明死信交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;deadLetterExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">deadLetterExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(DEAD_LETTER_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;deadLetterQueue1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">deadLetterQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DEAD_LETTER_QUEUE1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;deadLetterQueue2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">deadLetterQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DEAD_LETTER_QUEUE2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">deadLetterBinding1</span><span class="params">(<span class="meta">@Qualifier(&quot;deadLetterQueue1&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;deadLetterExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DEAD_LETTER_ROUTING_KEY1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">deadLetterBinding2</span><span class="params">(<span class="meta">@Qualifier(&quot;deadLetterQueue2&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;deadLetterExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DEAD_LETTER_ROUTING_KEY2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在配置类中注册了两个延迟队列和两个死信队列。</p>
<p>创建死信消息消费者<code>DeadLetterMessageReceiver</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterMessageReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DelayQueueConfig.DEAD_LETTER_QUEUE1)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveDeadLetter1</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;now: [&#123;&#125;], 『dead letter-1』 receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DelayQueueConfig.DEAD_LETTER_QUEUE2)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveDeadLetter2</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;now: [&#123;&#125;], 『dead letter-2』 receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建延时类型<code>DelayType</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">DelayType</span> &#123;</span><br><span class="line"></span><br><span class="line">    DELAY_3_SECONDS(<span class="number">1</span>, <span class="number">3000</span>),</span><br><span class="line">    DELAY_10_SECONDS(<span class="number">2</span>, <span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> type;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> delayTime;</span><br><span class="line"></span><br><span class="line">    DelayType(<span class="type">int</span> type, <span class="type">int</span> delayTime) &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">        <span class="built_in">this</span>.delayTime = delayTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getDelayTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> delayTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DelayType <span class="title function_">getDelayType</span><span class="params">(<span class="type">int</span> type)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (DelayType delayType : DelayType.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == delayType.getType()) &#123;</span><br><span class="line">                <span class="keyword">return</span> delayType;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建消息发送者<code>DelayMessageSender</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayMessageSender</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(String msg, DelayType type)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> DELAY_3_SECONDS:</span><br><span class="line">                rabbitTemplate.convertAndSend(DelayQueueConfig.DELAY_EXCHANGE, DelayQueueConfig.DELAY_QUEUE_ROUTING_KEY1, msg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DELAY_10_SECONDS:</span><br><span class="line">                rabbitTemplate.convertAndSend(DelayQueueConfig.DELAY_EXCHANGE, DelayQueueConfig.DELAY_QUEUE_ROUTING_KEY2, msg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建接口用于生产消息<code>MessageController</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rabbitmq/send&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DelayMessageSender delayMessageSender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送延时消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=1&quot;&gt;delay 3s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=2&quot;&gt;delay 10s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/delay&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String message, <span class="meta">@RequestParam(&quot;type&quot;)</span> Integer type)</span> &#123;</span><br><span class="line">        <span class="type">DelayType</span> <span class="variable">delayType</span> <span class="operator">=</span> DelayType.getDelayType(type);</span><br><span class="line">        <span class="keyword">if</span> (delayType == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;type is in [1, 2]&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;now: [&#123;&#125;], receive message: [&#123;&#125;], type: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), message, delayType);</span><br><span class="line">        delayMessageSender.sendMsg(message, delayType);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写启动类并运行，访问浏览器进行测试：</p>
<p>（1）访问：<a target="_blank" rel="noopener" href="http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=1">http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=1</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">18.662</span>  INFO <span class="number">14652</span> <span class="literal">---</span> [<span class="type">nio</span>-<span class="number">7777</span>-<span class="type">exec</span>-<span class="number">2</span>] top.parak.delay.MessageController        : now: [<span class="type">Tue</span> <span class="type">Sep</span> <span class="number">21</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">18</span> <span class="type">CST</span> <span class="number">2021</span>], receive message: [<span class="type">Khighness</span>], <span class="built_in">type</span>: [<span class="type">DELAY_3_SECONDS</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">21.666</span>  INFO <span class="number">14652</span> <span class="literal">---</span> [<span class="type">ntContainer</span><span class="comment">#0-1] t.parak.delay.DeadLetterMessageReceiver  : now: [Tue Sep 21 10:15:21 CST 2021], 『dead letter-1』 receive message: [Khighness]</span></span><br></pre></td></tr></table></figure>

<p>（2）访问：<a target="_blank" rel="noopener" href="http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=2">http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=2</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">26.273</span>  INFO <span class="number">14652</span> <span class="literal">---</span> [<span class="type">nio</span>-<span class="number">7777</span>-<span class="type">exec</span>-<span class="number">3</span>] top.parak.delay.MessageController        : now: [<span class="type">Tue</span> <span class="type">Sep</span> <span class="number">21</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">26</span> <span class="type">CST</span> <span class="number">2021</span>], receive message: [<span class="type">Khighness</span>], <span class="built_in">type</span>: [<span class="type">DELAY_10_SECONDS</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">36.276</span>  INFO <span class="number">14652</span> <span class="literal">---</span> [<span class="type">ntContainer</span><span class="comment">#1-1] t.parak.delay.DeadLetterMessageReceiver  : now: [Tue Sep 21 10:15:36 CST 2021], 『dead letter-2』 receive message: [Khighness]</span></span><br></pre></td></tr></table></figure>

<p>第一条消息在3S后变成死信消息，然后被消费者消费掉，第二条消息在10S之后变成死信消息。</p>
<p>如果这样使用的话，每增加一个新的时间需求，就要新增一个队列，那么对于预定会议室然后提前通知这样的场景，岂不是要增加无数个队列才能满足需求？</p>
<h3 id="8-6-队列优化"><a href="#8-6-队列优化" class="headerlink" title="8.6 队列优化"></a>8.6 队列优化</h3><p>为了实现一种更通用的方案，那么而只能将消息设置在消息属性里了。</p>
<p>在<code>DelayQueueConfig</code>中增加一个延时队列，不设置TTL，用于接收任意延时市场的消息，增加一个相应的死信队列和路由Key。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_QUEUE3</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.business.queue3&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_QUEUE_ROUTING_KEY3</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.business.key3&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_QUEUE3</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.deadletter.queue3&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_ROUTING_KEY3</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.deadletter.key3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不设置TTL</span></span><br><span class="line"><span class="meta">@Bean(&quot;delayQueue3&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">delayQueue3</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_LETTER_EXCHANGE);</span><br><span class="line">    map.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_LETTER_ROUTING_KEY3);</span><br><span class="line">    <span class="keyword">return</span> QueueBuilder.durable(DELAY_QUEUE3).withArguments(map).build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">delayBinding3</span><span class="params">(<span class="meta">@Qualifier(&quot;delayQueue3&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;delayExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DELAY_QUEUE_ROUTING_KEY3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean(&quot;deadLetterQueue3&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">deadLetterQueue3</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DEAD_LETTER_QUEUE3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">deadLetterBinding3</span><span class="params">(<span class="meta">@Qualifier(&quot;deadLetterQueue3&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;deadLetterExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DEAD_LETTER_ROUTING_KEY3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>DeadLetterMessageReceiver</code>中增加一个死信队列的消费者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = DelayQueueConfig.DEAD_LETTER_QUEUE3)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveDeadLetter3</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    log.info(<span class="string">&quot;now: [&#123;&#125;], 『dead letter-3』 receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>DelayMessageSender</code>中封装一个方法发送指定延时时间的消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(String msg, <span class="type">long</span> delayTime)</span> &#123;</span><br><span class="line">    rabbitTemplate.convertAndSend(DelayQueueConfig.DELAY_EXCHANGE, DelayQueueConfig.DELAY_QUEUE_ROUTING_KEY3, msg, m -&gt; &#123;</span><br><span class="line">        m.getMessageProperties().setExpiration(Long.toString(delayTime));</span><br><span class="line">        <span class="keyword">return</span> m;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>MessageController</code>中增加一个接口用于发送延时消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 发送延时消息，按照时间</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/time?msg=khighness&amp;time=1000&quot;&gt;delay 3s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/time?msg=khighness&amp;time=5000&quot;&gt;delay 5s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/time&quot;)</span></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String message, <span class="meta">@RequestParam(&quot;time&quot;)</span> Long time)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;now: [&#123;&#125;], receive message: [&#123;&#125;], time: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), message, time);</span><br><span class="line">    delayMessageSender.sendMsg(message, time);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新运行启动类，访问浏览器进行测试：<br>（1）访问：<a target="_blank" rel="noopener" href="http://localhost:7777/rabbitmq/send/time?msg=khighness&amp;time=1000">http://localhost:7777/rabbitmq/send/time?msg=khighness&amp;time=1000</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">56.532</span>  INFO <span class="number">13876</span> <span class="literal">---</span> [<span class="type">nio</span>-<span class="number">7777</span>-<span class="type">exec</span>-<span class="number">6</span>] top.parak.delay.MessageController        : now: [<span class="type">Tue</span> <span class="type">Sep</span> <span class="number">21</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">56</span> <span class="type">CST</span> <span class="number">2021</span>], receive message: [<span class="type">khighness</span>], time: [<span class="number">1000</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">57.539</span>  INFO <span class="number">13876</span> <span class="literal">---</span> [<span class="type">ntContainer</span><span class="comment">#0-1] t.parak.delay.DeadLetterMessageReceiver  : now: [Tue Sep 21 12:35:57 CST 2021], 『dead letter-3』 receive message: [khighness]</span></span><br></pre></td></tr></table></figure>

<p>（2）访问：<a target="_blank" rel="noopener" href="http://localhost:7777/rabbitmq/send/time?msg=khighness&amp;time=5000">http://localhost:7777/rabbitmq/send/time?msg=khighness&amp;time=5000</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">12</span>:<span class="number">36</span>:<span class="number">00.917</span>  INFO <span class="number">13876</span> <span class="literal">---</span> [<span class="type">nio</span>-<span class="number">7777</span>-<span class="type">exec</span>-<span class="number">7</span>] top.parak.delay.MessageController        : now: [<span class="type">Tue</span> <span class="type">Sep</span> <span class="number">21</span> <span class="number">12</span>:<span class="number">36</span>:<span class="number">00</span> <span class="type">CST</span> <span class="number">2021</span>], receive message: [<span class="type">khighness</span>], time: [<span class="number">5000</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">12</span>:<span class="number">36</span>:<span class="number">05.921</span>  INFO <span class="number">13876</span> <span class="literal">---</span> [<span class="type">ntContainer</span><span class="comment">#0-1] t.parak.delay.DeadLetterMessageReceiver  : now: [Tue Sep 21 12:36:05 CST 2021], 『dead letter-3』 receive message: [khighness]</span></span><br></pre></td></tr></table></figure>



<h3 id="8-7-插件实现"><a href="#8-7-插件实现" class="headerlink" title="8.7 插件实现"></a>8.7 插件实现</h3><p>如果不能实现在消息粒度上添加TTL，并使其在设置的TTL时间内即时即时死亡，就无法设计一个通用的延时队列。</p>
<p>这时使用RabbitMQ的插件即可解决：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/community-plugins.html">https://www.rabbitmq.com/community-plugins.html</a> </p>
<p>延时插件安装</p>
<ol>
<li><p>下载插件：<a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases">https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases</a></p>
</li>
<li><p>复制到容器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">cp</span> rabbitmq_delayed_message_exchange-3.8.9-0199d11c.ez rabbitmq:/plugins</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>激活插件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">exec</span> -it rabbitmq bash</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_delayed_message_exchange</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>打开Web控制台，可以看到有新的交换机类型：<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/x-delayed-message.png" class="" title="x-delayed-message"><br /></p>
<p>在<code>DelayQueueConfig</code>中创建新的交换机和队列：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_MESSAGE_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.delayed.message.exchange&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_MESSAGE_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.delayed.message.queue&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_MESSAGE_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;parak.delay.queue.delayed.message.key&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 声明自定义交换机</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="meta">@Bean(&quot;delayedMessageExchange&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CustomExchange <span class="title function_">delayedMessageExchange</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    args.put(<span class="string">&quot;x-delayed-type&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(DELAYED_MESSAGE_EXCHANGE, <span class="string">&quot;x-delayed-message&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean(&quot;delayedMessageQueue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">delayedMessageQueue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DELAYED_MESSAGE_QUEUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">delayedMessageBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;delayedMessageQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;delayedMessageExchange&quot;)</span> CustomExchange exchange)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DELAYED_MESSAGE_ROUTING_KEY).noargs();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建延迟队列的消息消费者<code>DelayedMessageReceiver</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayedMessageReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DelayQueueConfig.DELAYED_MESSAGE_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveDeadLetter1</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;now: [&#123;&#125;], 『delayed message』 receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>DelayMessageSender</code>中封装新的方法用于向延时交换机中发送消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsgToDelayedExchange</span><span class="params">(String msg, <span class="type">long</span> delayTime)</span> &#123;</span><br><span class="line">    rabbitTemplate.convertAndSend(DelayQueueConfig.DELAYED_MESSAGE_EXCHANGE, DelayQueueConfig.DELAYED_MESSAGE_ROUTING_KEY, msg, m -&gt; &#123;</span><br><span class="line">        m.getMessageProperties().setExpiration(Long.toString(delayTime));</span><br><span class="line">        <span class="keyword">return</span> m;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>MessageController</code>中添加新的接口用于发送延时消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 发送延时消息，按照时间</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/delayed?msg=khighness&amp;time=1000&quot;&gt;delay 3s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/delayed?msg=khighness&amp;time=5000&quot;&gt;delay 5s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/delayed&quot;)</span></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">sendMsgToDelayedExchange</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String message, <span class="meta">@RequestParam(&quot;time&quot;)</span> Long time)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;now: [&#123;&#125;], receive message: [&#123;&#125;], time: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), message, time);</span><br><span class="line">    delayMessageSender.sendMsgToDelayedExchange(message, time);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-8-一个小结"><a href="#8-8-一个小结" class="headerlink" title="8.8 一个小结"></a>8.8 一个小结</h3><p>延时队列在需要延时处理的场景下非常有用，使用RabbitMQ来实现延时队列可以很好的利用、RabbitMQ的特性，如：消息可靠性发送、消息可靠性投递以及死信队列来保障消息至少被消费一次以及未被正确处理的消息不会被丢弃。</p>
<p>当然，那是队列还有很多其它选择，比如利用Java的<code>DelayQueue</code>，利用Redis的<code>ZSet</code>，利用<code>Quartz</code>或者Kafka的时间轮，这些方式各有特点。了解的越多，遇到问题便能游刃有余。</p>
<h2 id="9-RabbitMQ可靠投递"><a href="#9-RabbitMQ可靠投递" class="headerlink" title="9. RabbitMQ可靠投递"></a>9. RabbitMQ可靠投递</h2><h3 id="9-1-可靠投递"><a href="#9-1-可靠投递" class="headerlink" title="9.1 可靠投递"></a>9.1 可靠投递</h3><p>在RabbitMQ中，一个消息从生产者发送到RabbitMQ的服务器，需要经历以下步骤：</p>
<ol>
<li>生产者准备好需要投递的消息；</li>
<li>生产者与RabbitMQ服务器建立连接；</li>
<li>生产者发送消息；</li>
<li>RabbitMQ服务器接收到消息，并将其路由到指定队列；</li>
<li>RabbitMQ服务器发起回调，告知生产者消息发送成功。</li>
</ol>
<p>所谓可靠投递，就是确保消息能够保证从生产者发送到服务器。</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/Confirm.svg" class="" title="Confirm">

<p>说明：如果没有设置<code>Mandatory</code>，是不需要先路由消息才发起回调的，服务器收到消息后就会进行回调确认。</p>
<p>2、3、5步都是通过TCP连接进行交互，有网络调用的地方就会有事故，网络波动随时都有可能发生，不管是内部机房停电，还是外部光缆被切，网络事故无法预测，虽然这些都是小概率事件，但是对于敏感数据来说，这些情况下导致消息丢失都是不可接受的。</p>
<h3 id="9-2-实现原理"><a href="#9-2-实现原理" class="headerlink" title="9.2 实现原理"></a>9.2 实现原理</h3><p>默认情况下，发送消息的操作是不会反悔任何消息给生产者的，也就是说，默认情况下生产者是不知道消息有没有正确地到达服务器。</p>
<p>对此，RabbitMQ中有一些相关的解决方案：</p>
<ol>
<li>使用事务机制来让生产者感知消息被成功投递到服务器；</li>
<li>通过生产者确认机制实现。</li>
</ol>
<p>在RabbitMQ中，所有确保消息可靠投递都会对性能产生一定影响，如果使用不当，可能会对吞吐量造成重大影响，只有通过执行性能基准测试，才能在确定性能与可靠投递之间的平衡。</p>
<h3 id="9-3-事务机制"><a href="#9-3-事务机制" class="headerlink" title="9.3 事务机制"></a>9.3 事务机制</h3><p>RabbitMQ是支持事务机制的，在生产者确认机制之前，事务是确保消息被成功投递的唯一办法。</p>
<p>创建项目，引入依赖。</p>
<p>项目配置<code>application.properties</code>：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">8888</span></span><br><span class="line"><span class="attr">spring.application.name</span>=<span class="string">springboot-reliable-transaction</span></span><br><span class="line"><span class="attr">spring.rabbitmq.host</span>=<span class="string">192.168.117.155</span></span><br><span class="line"><span class="attr">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="attr">spring.rabbitmq.virtual-host</span>=<span class="string">/learn</span></span><br><span class="line"><span class="attr">spring.rabbitmq.username</span>=<span class="string">parak</span></span><br><span class="line"><span class="attr">spring.rabbitmq.password</span>=<span class="string">KAG1823</span></span><br><span class="line"><span class="attr">spring.rabbitmq.listener.type</span>=<span class="string">simple</span></span><br><span class="line"><span class="attr">spring.rabbitmq.listener.simple.default-requeue-rejected</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">spring.rabbitmq.listener.simple.acknowledge-mode</span>=<span class="string">manual</span></span><br></pre></td></tr></table></figure>

<p>创建配置类<code>RabbitMQConfig</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.transaction.RabbitTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;parak.reliable.transaction.business.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;parak.reliable.transaction.business.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明业务交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;businessExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">businessExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(BUSINESS_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;businessQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">businessQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_QUEUE).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">businessBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;businessQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;businessExchange&quot;)</span> FanoutExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启用RabbitMQ事务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RabbitTransactionManager <span class="title function_">rabbitTransactionManager</span><span class="params">(CachingConnectionFactory connectionFactory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RabbitTransactionManager</span>(connectionFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建业务消息消费者<code>BusinessMessageReceiver</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessMessageReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.BUSINESS_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『business』 receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        channel.basicNack(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建业务消息发送者<code>BusinessMessageSender</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessMessageSender</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        rabbitTemplate.setChannelTransacted(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMQConfig.BUSINESS_EXCHANGE, RabbitMQConfig.DEFAULT_ROUTING_KEY, msg);</span><br><span class="line">        log.info(<span class="string">&quot;message: [&#123;&#125;]&quot;</span>, msg);</span><br><span class="line">        <span class="keyword">if</span> (msg == <span class="literal">null</span> || msg.equals(<span class="string">&quot;&quot;</span>) || msg.contains(<span class="string">&quot;exception&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;message sent successfully: [&#123;&#125;]&quot;</span>, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建接口用于生产消息<code>MessageController</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rabbitmq/send&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BusinessMessageSender businessMessageSender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a hred=&quot;http://localhost:8888/rabbitmq/send/tx?msg=Khighness&quot;&gt;succeed&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a hred=&quot;http://localhost:8888/rabbitmq/send/tx?msg=Kexception&quot;&gt;exception&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/tx&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String msg)</span> &#123;</span><br><span class="line">        businessMessageSender.sendMsg(msg);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写启动类并运行，访问浏览器进行测试：</p>
<p>（1）访问：<a target="_blank" rel="noopener" href="http://localhost:8888/rabbitmq/send/tx?msg=Khighness">http://localhost:8888/rabbitmq/send/tx?msg=Khighness</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">55.913</span>  INFO <span class="number">18096</span> <span class="literal">---</span> [<span class="type">nio</span>-<span class="number">8888</span>-<span class="type">exec</span>-<span class="number">5</span>] t.p.transaction.BusinessMessageSender    : message: [<span class="type">Khighness</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">55.913</span>  INFO <span class="number">18096</span> <span class="literal">---</span> [<span class="type">nio</span>-<span class="number">8888</span>-<span class="type">exec</span>-<span class="number">5</span>] t.p.transaction.BusinessMessageSender    : message sent successfully: [<span class="type">Khighness</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">55.915</span>  INFO <span class="number">18096</span> <span class="literal">---</span> [<span class="type">ntContainer</span><span class="comment">#0-1] t.p.transaction.BusinessMessageReceiver  : 『business』 receive message: [Khighness]</span></span><br></pre></td></tr></table></figure>

<p>（2）访问：<a target="_blank" rel="noopener" href="http://localhost:8888/rabbitmq/send/tx?msg=Kexception">http://localhost:8888/rabbitmq/send/tx?msg=Kexception</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">59.444</span>  INFO <span class="number">18096</span> <span class="literal">---</span> [<span class="type">nio</span>-<span class="number">8888</span>-<span class="type">exec</span>-<span class="number">6</span>] t.p.transaction.BusinessMessageSender    : message: [<span class="type">Kexception</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">59.445</span> ERROR <span class="number">18096</span> <span class="literal">---</span> [<span class="type">nio</span>-<span class="number">8888</span>-<span class="type">exec</span>-<span class="number">6</span>] o.a.c.c.C.[<span class="type">.</span>[<span class="type">.</span>[/]<span class="type">.</span>[<span class="type">dispatcherServlet</span>]    : <span class="type">Servlet.service</span>() <span class="type">for</span> <span class="type">servlet</span> [<span class="type">dispatcherServlet</span>] <span class="type">in</span> <span class="type">context</span> <span class="type">with</span> <span class="type">path</span> [] <span class="type">threw</span> <span class="type">exception</span> [<span class="type">Request</span> <span class="type">processing</span> <span class="type">failed</span>; <span class="type">nested</span> <span class="type">exception</span> <span class="type">is</span> <span class="type">java.lang.RuntimeException</span>: <span class="type">error</span>] <span class="type">with</span> <span class="type">root</span> <span class="type">cause</span></span><br><span class="line"></span><br><span class="line"><span class="type">java.lang.RuntimeException</span>: <span class="type">error</span></span><br></pre></td></tr></table></figure>

<p>编码过程中，有两个需要注意的地方：</p>
<ol>
<li>在初始化消息发送者的时候，需要在初始化中使用<code>rabbitTemplate.setChannelTrsansacted(true)</code>来开启事务；</li>
<li>在发送消息的方法上加上<code>@Transactional</code>注解，这样在该方法发生异常时，消息将不会发送。</li>
</ol>
<p>RabbitMQ中的事务使用起来虽然简单，但是对性能的形象是不可忽视的，因为每次事务的提交都是阻塞式的等待服务器返回结果，而默认模式下，客户端是不需要等待的，直接发送就完事了，除此之外，事务消息需要比普通消息多4次与服务器的交互，这就意味着会占用着更多的处理时间，所以如果对消息处理速度有较高要求时，尽量不要采用事务机制。</p>
<h3 id="9-4-生产者确认机制"><a href="#9-4-生产者确认机制" class="headerlink" title="9.4 生产者确认机制"></a>9.4 生产者确认机制</h3><p>RabbitMQ中的生产者确认功能是AMQP规范的增强功能，当生产者发布给所有队列的已路由消息被消费者应用程序直接消费时，或者消息被放入队列并根据需要进行持久化时，一个Basic Ack请求会被发送到生产者，如果消息无法路由，代理服务器将发送一个Basic Nack RPC请求用于表示失败。然后由生产者决定该如何处理该消息。</p>
<p>简而言之，通过生产者确认机制，生产者可以在消息被代理服务器成功接收时得到反馈，并有机会处理未被成功接收的消息。</p>
<p>创建项目，引入依赖。</p>
<p>项目配置在上述配置上需要加一行开启生产者确认：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.rabbitmq.publisher-confirms</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>创建配置类<code>RabbitMQConfig</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.transaction.RabbitTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;parak.reliable.confirm.business.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;parak.reliable.confirm.business.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_KEY</span> <span class="operator">=</span> <span class="string">&quot;parak.reliable.confirm.business.key&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;businessExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">businessExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(BUSINESS_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;businessQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">businessQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_QUEUE).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">businessBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;businessQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;businessExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(BUSINESS_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建消息发送者<code>BusinessMessageSender</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessMessageSender</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="type">CorrelationData</span> <span class="variable">correlationData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(UUID.randomUUID().toString());</span><br><span class="line">        log.info(<span class="string">&quot;id: [&#123;&#125;], message: [&#123;&#125;]&quot;</span>, correlationData.getId(), msg);</span><br><span class="line">        <span class="comment">// 设置消息ID，用于回调时的判断</span></span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMQConfig.BUSINESS_EXCHANGE, RabbitMQConfig.DEFAULT_ROUTING_KEY, msg, correlationData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> b, String s)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> correlationData != <span class="literal">null</span> ? correlationData.getId() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (b) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;message confirm succeed, id: [&#123;&#125;]&quot;</span>, id);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;message confirm failed, id: [&#123;&#125;], cause: [&#123;&#125;]&quot;</span>, id, s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要为消息设置消息ID，以便在回调时通过该ID来判断是对哪个消息的回调，因为在回调函数中，我们是无法直接获取到消息内容的，所以需要将消息先暂存起来，根据消息的重要程度，可以考虑使用本地缓存，或者存入Redis中，或者MySQL中，然后在回调时更新其状态或者从缓存中移除，最后使用定时任务对一段时间内未发送的消息进行重新投递。</p>
<h3 id="9-6-可靠投递到队列"><a href="#9-6-可靠投递到队列" class="headerlink" title="9.6 可靠投递到队列"></a>9.6 可靠投递到队列</h3><p>上面使用了两种方式实现了消息被可靠地投递到RabbitMQ的交换机中，但是如果如果Broker无法将消息路由到队列，还是会被丢弃。</p>
<p>RabbitMQ有两个机制可以实现可靠投递到队列：</p>
<ol>
<li>mandatory参数：将不可路由消息退回给生产者；</li>
<li>备份交换机：将不可路由消息转发给备份交换机。</li>
</ol>
<p>第一种方式只需要在初始化<code>rabbitTemplate</code>的时候添加一行代码即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitTemplate.setMandatory(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p>先演示消息丢弃情况，创建项目，引入依赖。</p>
<p>项目配置<code>application.properties</code>：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">11111</span></span><br><span class="line"><span class="attr">spring.application.name</span>=<span class="string">springboot-reliable-queue</span></span><br><span class="line"><span class="attr">spring.rabbitmq.host</span>=<span class="string">192.168.117.155</span></span><br><span class="line"><span class="attr">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="attr">spring.rabbitmq.virtual-host</span>=<span class="string">/learn</span></span><br><span class="line"><span class="attr">spring.rabbitmq.username</span>=<span class="string">parak</span></span><br><span class="line"><span class="attr">spring.rabbitmq.password</span>=<span class="string">KAG1823</span></span><br><span class="line"><span class="attr">spring.rabbitmq.listener.type</span>=<span class="string">simple</span></span><br><span class="line"><span class="attr">spring.rabbitmq.listener.simple.default-requeue-rejected</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">spring.rabbitmq.listener.simple.acknowledge-mode</span>=<span class="string">manual</span></span><br><span class="line"><span class="attr">spring.rabbitmq.publisher-confirms</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>创建配置类<code>RabbitMQConfig</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;parak.reliable.queue.business.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;parak.reliable.queue.business.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_KEY</span> <span class="operator">=</span> <span class="string">&quot;key&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明业务交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;businessExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">businessExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(BUSINESS_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;businessQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">businessQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_QUEUE).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">businessBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;businessQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;businessExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(BUSINESS_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建消息消费者<code>BusinessMessageReceiver</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessMessageReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.BUSINESS_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『business』 receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        channel.basicNack(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建消息发送者<code>BusinessMessageSender</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessMessageSender</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">        rabbitTemplate.setMandatory(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(String routingKey, String message)</span> &#123;</span><br><span class="line">        <span class="type">CorrelationData</span> <span class="variable">correlationData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(UUID.randomUUID().toString());</span><br><span class="line">        log.info(<span class="string">&quot;id: [&#123;&#125;], message: [&#123;&#125;]&quot;</span>, correlationData.getId(), message);</span><br><span class="line">        <span class="comment">// 设置消息ID，用于回调时的判断</span></span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMQConfig.BUSINESS_EXCHANGE, routingKey, message, correlationData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> b, String s)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> correlationData != <span class="literal">null</span> ? correlationData.getId() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (b) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;message confirm succeed, id: [&#123;&#125;]&quot;</span>, id);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;message confirm failed, id: [&#123;&#125;], cause: [&#123;&#125;]&quot;</span>, id, s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建接口发送消息<code>MessageController</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rabbitmq/send&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BusinessMessageSender businessMessageSender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a hred=&quot;http://localhost:11111/rabbitmq/send/confirm?msg=Khighness&quot;&gt;succeed&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a hred=&quot;http://localhost:11111/rabbitmq/send/confirm?msg=Kexception&quot;&gt;exception&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/confirm&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@RequestParam(&quot;key&quot;)</span> String routingKey, <span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> &#123;</span><br><span class="line">        businessMessageSender.sendMsg(routingKey, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写启动类并运行，访问浏览器进行测试：</p>
<p>（1）访问：<a target="_blank" rel="noopener" href="http://localhost:11111/rabbitmq/send/queue?key=key&amp;msg=Khighness">http://localhost:11111/rabbitmq/send/queue?key=key&amp;msg=Khighness</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">22</span>:<span class="number">58</span>:<span class="number">33.392</span>  INFO <span class="number">21368</span> <span class="literal">---</span> [<span class="type">io</span>-<span class="number">11111</span>-<span class="type">exec</span>-<span class="number">5</span>] top.parak.queue.BusinessMessageSender    : id: [<span class="number">81</span><span class="type">ff86f3</span>-<span class="number">0000</span>-<span class="number">4</span><span class="type">edb</span>-<span class="type">b6a5</span>-<span class="number">92494</span><span class="type">f27be3c</span>], message: [<span class="type">Khighness</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">22</span>:<span class="number">58</span>:<span class="number">33.394</span>  INFO <span class="number">21368</span> <span class="literal">---</span> [<span class="type">ntContainer</span><span class="comment">#0-1] top.parak.queue.BusinessMessageReceiver  : 『business』 receive message: [Khighness]</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">58</span>:<span class="number">33.394</span>  <span class="type">INFO</span> <span class="number">21368</span> --- [<span class="type">nectionFactory2</span>] <span class="type">top.parak.queue.BusinessMessageSender</span>    : <span class="type">message</span> <span class="type">confirm</span> <span class="type">succeed</span>, <span class="type">id</span>: [<span class="number">81</span><span class="type">ff86f3</span>-<span class="number">0000</span>-<span class="number">4</span><span class="type">edb</span>-<span class="type">b6a5</span>-<span class="number">92494</span><span class="type">f27be3c</span>]</span><br></pre></td></tr></table></figure>

<p>（2）访问：<a target="_blank" rel="noopener" href="http://localhost:11111/rabbitmq/send/queue?key=kkk&amp;msg=FlowerK">http://localhost:11111/rabbitmq/send/queue?key=kkk&amp;msg=FlowerK</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">22</span>:<span class="number">58</span>:<span class="number">34.867</span>  INFO <span class="number">21368</span> <span class="literal">---</span> [<span class="type">io</span>-<span class="number">11111</span>-<span class="type">exec</span>-<span class="number">9</span>] top.parak.queue.BusinessMessageSender    : id: [<span class="number">373</span><span class="type">c027e</span>-<span class="number">8</span><span class="type">e8e</span>-<span class="number">4</span><span class="type">f2a</span>-<span class="type">b59c</span>-<span class="number">53</span><span class="type">a8b7553767</span>], message: [<span class="type">FlowerK</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">22</span>:<span class="number">58</span>:<span class="number">34.868</span>  INFO <span class="number">21368</span> <span class="literal">---</span> [<span class="type">nectionFactory1</span>] top.parak.queue.BusinessMessageSender    : message confirm succeed, id: [<span class="number">373</span><span class="type">c027e</span>-<span class="number">8</span><span class="type">e8e</span>-<span class="number">4</span><span class="type">f2a</span>-<span class="type">b59c</span>-<span class="number">53</span><span class="type">a8b7553767</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">22</span>:<span class="number">58</span>:<span class="number">34.868</span>  WARN <span class="number">21368</span> <span class="literal">---</span> [<span class="type">nectionFactory2</span>] o.s.amqp.rabbit.core.RabbitTemplate      : Returned message but no callback available</span><br></pre></td></tr></table></figure>

<p>可以看到第二个消息发送后的提示<code>Returned message but no callback available</code>。</p>
<p>设置<code>mandatory</code>参数后，如果消息无法被路由，则会返回给生产者，是通过回调的方式进行的，所以，生产者需要设置相应的回调函数才能接受消息。</p>
<p>为了进行回调，消息发送者需要实现回调接口<code>RabbitTemplate.ReturnCallback</code>，实现<code>returnedMessage</code>方法，同时在初始化时设置回调接口为自己：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">    rabbitTemplate.setMandatory(<span class="literal">true</span>);</span><br><span class="line">    rabbitTemplate.setReturnCallback(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message, <span class="type">int</span> relayCode, String replyText, String exchange, String routingKey)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;message is returned. msg: [&#123;&#125;], replayCode: [&#123;&#125;], replyText: [&#123;&#125;]exchange: [&#123;&#125;], routingKey: [&#123;&#125;]&quot;</span>,</span><br><span class="line">             <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()), relayCode, replyText, exchange, routingKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新运行启动类，访问浏览器后日志如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">23</span>:<span class="number">17</span>:<span class="number">55.245</span>  INFO <span class="number">24700</span> <span class="literal">---</span> [<span class="type">io</span>-<span class="number">11111</span>-<span class="type">exec</span>-<span class="number">1</span>] top.parak.queue.BusinessMessageSender    : id: [<span class="type">ad8a28ed</span>-<span class="type">b21c</span>-<span class="number">497</span><span class="type">d</span>-<span class="number">87</span><span class="type">c4</span>-<span class="type">ff3c447204db</span>], message: [<span class="type">FlowerK</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">23</span>:<span class="number">17</span>:<span class="number">55.253</span>  INFO <span class="number">24700</span> <span class="literal">---</span> [<span class="type">nectionFactory1</span>] top.parak.queue.BusinessMessageSender    : message is returned. msg: [<span class="type">FlowerK</span>], replayCode: [<span class="number">312</span>], replyText: [<span class="type">NO_ROUTE</span>], exchange: [<span class="type">parak.reliable.queue.business.exchange</span>], routingKey: [<span class="type">kkk</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09-21</span> <span class="number">23</span>:<span class="number">17</span>:<span class="number">55.254</span>  INFO <span class="number">24700</span> <span class="literal">---</span> [<span class="type">nectionFactory1</span>] top.parak.queue.BusinessMessageSender    : message confirm succeed, id: [<span class="type">ad8a28ed</span>-<span class="type">b21c</span>-<span class="number">497</span><span class="type">d</span>-<span class="number">87</span><span class="type">c4</span>-<span class="type">ff3c447204db</span>]</span><br></pre></td></tr></table></figure>

<p>可以看到，我们接收到了被退回的消息，并带上了原因。但是要注意的是，<code>mandatory</code>参数仅仅是在当消息无法北路由的时候，让消息生产者感知到这一点，只要开启了生产者确认机制，无论设置了<code>mandatory</code>参数，都会在交换机接收到消息时进行消息确认回调，而且通常消息的退回会在消息的确认回调之前。</p>
<p>通过<code>mandatory</code>参数我们获得了对无法投递消息的感知能力，有机会在生产者的消息无法被投递时发现并处理。但有时候，我们并不知道该如何处理这些无法路由的消息，最多打印个日志，然后触发报警，再来手动处理。而通过日志来处理这些无法路由的消息是很不优雅的做法，特别是当生产者所在的服务器有多台机器的时候，手动复制会更加麻烦而且容易出错。</p>
<p>而且设置<code>mandatory</code>参数会增加生产者的复杂性，需要添加处理这些被退回的消息的逻辑。如果既不想丢失消息，又不想增加生产者的复杂性，该怎么做呢？</p>
<p>RabbitMQ有一种备份交换机的机制存在，可以很好的应对这个问题。</p>
<p>备份交换机可以理解为RabbitMQ中的交换机的备胎，当我们为某一个交换机声明一个对应的备份交换机时，就是为它创建一个备胎，当交换机接收到一条不可路由消息时，将会将这条消息转发到备份交换机中，由备份交换机来进行钻发和处理，通常备份交换机的类型为<code>Fanout</code>，这样就能把所有消息都投递到与其绑定的队列中，然后我们在备份交换机下绑定一个队列，这样所有那些原交换机无法被路由的消息，就会进入这个队列了。当然，我们还可以建立一个报警队列，用独立的消费者来进行监测和报警。</p>
<p>草图如下：</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/Copy.svg" class="" title="Copy"><br />

<p>创建项目，引入依赖，配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server.port=<span class="number">12222</span></span><br><span class="line">spring.application.name=springboot-exchange-backup</span><br><span class="line">spring.rabbitmq.host=<span class="number">192.168</span><span class="number">.117</span><span class="number">.155</span></span><br><span class="line">spring.rabbitmq.port=<span class="number">5672</span></span><br><span class="line">spring.rabbitmq.virtual-host=/learn</span><br><span class="line">spring.rabbitmq.username=parak</span><br><span class="line">spring.rabbitmq.password=KAG1823</span><br><span class="line">spring.rabbitmq.listener.type=simple</span><br><span class="line">spring.rabbitmq.listener.simple.<span class="keyword">default</span>-requeue-rejected=<span class="literal">false</span></span><br><span class="line">spring.rabbitmq.listener.simple.acknowledge-mode=manual</span><br><span class="line">spring.rabbitmq.publisher-confirms=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>创建配置类<code>RabbitMQConfig</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;parak.exchange.backup.business.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;parak.exchange.backup.business.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_KEY</span> <span class="operator">=</span> <span class="string">&quot;key&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_BACKUP_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;parak.exchange.backup.backup.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_BACKUP_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;parak.exchange.backup.backup.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_BACKUP_WARNING_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;parak.exchange.backup.backup.warning.queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明业务交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;businessExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">businessExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ExchangeBuilder</span> <span class="variable">exchangeBuilder</span> <span class="operator">=</span> ExchangeBuilder.directExchange(BUSINESS_EXCHANGE)</span><br><span class="line">                .durable(<span class="literal">true</span>)</span><br><span class="line">                <span class="comment">// 设置备份交换机</span></span><br><span class="line">                .withArgument(<span class="string">&quot;alternate-exchange&quot;</span>, BUSINESS_BACKUP_EXCHANGE);</span><br><span class="line">        <span class="keyword">return</span> (DirectExchange) exchangeBuilder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;businessQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">businessQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_QUEUE).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">businessBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;businessQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;businessExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(BUSINESS_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明备份交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;backupExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">backupExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ExchangeBuilder</span> <span class="variable">exchangeBuilder</span> <span class="operator">=</span> ExchangeBuilder.fanoutExchange(BUSINESS_BACKUP_EXCHANGE)</span><br><span class="line">                .durable(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> exchangeBuilder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;backupQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">backupQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_BACKUP_QUEUE).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;warningQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">warningQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_BACKUP_WARNING_QUEUE).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">backupBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;backupQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;backupExchange&quot;)</span> FanoutExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">warningBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;warningQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;backupExchange&quot;)</span> FanoutExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建业务消息消费者<code>BusinessMessageReceiver</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessMessageReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.BUSINESS_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;『business』 receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        channel.basicNack(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建报警消息消费者<code>BusinessWarningMessageReceiver</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessWarningMessageReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.BUSINESS_BACKUP_WARNING_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.error(<span class="string">&quot;『warning』 receive unroutable message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建消息发送者<code>BusinessMessageSender</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessMessageSender</span><span class="comment">/* implements RabbitTemplate.ConfirmCallback, RabbitTemplate.ReturnCallback */</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(String routingKey, String message)</span> &#123;</span><br><span class="line">        <span class="type">CorrelationData</span> <span class="variable">correlationData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(UUID.randomUUID().toString());</span><br><span class="line">        log.info(<span class="string">&quot;id: [&#123;&#125;], message: [&#123;&#125;]&quot;</span>, correlationData.getId(), message);</span><br><span class="line">        <span class="comment">// 设置消息ID，用于回调时的判断</span></span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMQConfig.BUSINESS_EXCHANGE, routingKey, message, correlationData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建接口用于发送消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rabbitmq/send&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BusinessMessageSender businessMessageSender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:12222/rabbitmq/send/backup?key=key&amp;msg=Khighness&quot;&gt;succeed&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:12222/rabbitmq/send/backup?key=kkk&amp;msg=FlowerK&quot;&gt;fail&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/backup&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@RequestParam(&quot;key&quot;)</span> String routingKey, <span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> &#123;</span><br><span class="line">        businessMessageSender.sendMsg(routingKey, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写启动类并运行，访问浏览器进行测试：</p>
<p>（1）访问：<a target="_blank" rel="noopener" href="http://localhost:12222/rabbitmq/send/backup?key=key&amp;msg=Khighness">http://localhost:12222/rabbitmq/send/backup?key=key&amp;msg=Khighness</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09-22</span> <span class="number">11</span>:<span class="number">41</span>:<span class="number">58.976</span>  INFO <span class="number">16192</span> <span class="literal">---</span> [<span class="type">io</span>-<span class="number">12222</span>-<span class="type">exec</span>-<span class="number">1</span>] top.parak.backup.BusinessMessageSender   : id: [<span class="type">f8896978</span>-<span class="type">db6c</span>-<span class="number">47</span><span class="type">bb</span>-<span class="number">9</span><span class="type">af7</span>-<span class="number">0</span><span class="type">f0c15fb81f3</span>], message: [<span class="type">Khighness</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09-22</span> <span class="number">11</span>:<span class="number">41</span>:<span class="number">58.988</span>  INFO <span class="number">16192</span> <span class="literal">---</span> [<span class="type">ntContainer</span><span class="comment">#0-1] t.parak.backup.BusinessMessageReceiver   : 『business』 receive message: [Khighness]</span></span><br></pre></td></tr></table></figure>

<p>（2）访问：<a target="_blank" rel="noopener" href="http://localhost:12222/rabbitmq/send/backup?key=kkk&amp;msg=FlowerK">http://localhost:12222/rabbitmq/send/backup?key=kkk&amp;msg=FlowerK</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2021-09-22 11:42:02.200  INFO 16192 --- [io-12222-exec-3] top.parak.backup.BusinessMessageSender   : id: [c56b5191-7810-4936-8c34-ef88ac16ccd2], message: [FlowerK]</span><br><span class="line">2021-09-22 11:42:02.202 ERROR 16192 --- [ntContainer#1-1] t.p.b.BusinessWarningMessageReceiver     : 『warning』 receive unroutable message: [FlowerK]</span><br></pre></td></tr></table></figure>

<p>那么，如果<code>mandatory</code>参数与备份交换机一起使用，消息会被退回到生产者还是被转发给交换机呢？</p>
<p>修改消息发送者<code>BusinessMessageSender</code>的代码，测试一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.backup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessMessageSender</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback, RabbitTemplate.ReturnCallback &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">        rabbitTemplate.setMandatory(<span class="literal">true</span>);</span><br><span class="line">        rabbitTemplate.setReturnCallback(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(String routingKey, String message)</span> &#123;</span><br><span class="line">        <span class="type">CorrelationData</span> <span class="variable">correlationData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(UUID.randomUUID().toString());</span><br><span class="line">        log.info(<span class="string">&quot;id: [&#123;&#125;], message: [&#123;&#125;]&quot;</span>, correlationData.getId(), message);</span><br><span class="line">        <span class="comment">// 设置消息ID，用于回调时的判断</span></span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMQConfig.BUSINESS_EXCHANGE, routingKey, message, correlationData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> b, String s)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> correlationData != <span class="literal">null</span> ? correlationData.getId() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (b) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;message confirm succeed, id: [&#123;&#125;]&quot;</span>, id);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;message confirm failed, id: [&#123;&#125;], cause: [&#123;&#125;]&quot;</span>, id, s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message, <span class="type">int</span> relayCode, String replyText, String exchange, String routingKey)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;message is returned. msg: [&#123;&#125;], replayCode: [&#123;&#125;], replyText: [&#123;&#125;], exchange: [&#123;&#125;], routingKey: [&#123;&#125;]&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()), relayCode, replyText, exchange, routingKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新运行启动类，重新访问浏览器：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09-22</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">30.713</span>  INFO <span class="number">2688</span> <span class="literal">---</span> [<span class="type">nectionFactory1</span>] top.parak.backup.BusinessMessageSender   : message confirm succeed, id: [<span class="type">ab911258</span>-<span class="number">3966</span>-<span class="number">4</span><span class="type">e3e</span>-<span class="number">9</span><span class="type">cfb</span>-<span class="number">0</span><span class="type">b920bc97807</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09-22</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">30.715</span>  INFO <span class="number">2688</span> <span class="literal">---</span> [<span class="type">ntContainer</span><span class="comment">#0-1] t.parak.backup.BusinessMessageReceiver   : 『business』 receive message: [Khighness]</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">37.117</span>  <span class="type">INFO</span> <span class="number">2688</span> --- [<span class="type">io</span>-<span class="number">12222</span>-<span class="type">exec</span>-<span class="number">2</span>] <span class="type">top.parak.backup.BusinessMessageSender</span>   : <span class="type">id</span>: [<span class="type">ebaa3643</span>-<span class="number">731</span><span class="type">d</span>-<span class="number">430</span><span class="type">d</span>-<span class="type">ac92</span>-<span class="number">73</span><span class="type">e39439a262</span>], <span class="type">message</span>: [<span class="type">FlowerK</span>]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">37.120</span>  <span class="type">INFO</span> <span class="number">2688</span> --- [<span class="type">nectionFactory1</span>] <span class="type">top.parak.backup.BusinessMessageSender</span>   : <span class="type">message</span> <span class="type">confirm</span> <span class="type">succeed</span>, <span class="type">id</span>: [<span class="type">ebaa3643</span>-<span class="number">731</span><span class="type">d</span>-<span class="number">430</span><span class="type">d</span>-<span class="type">ac92</span>-<span class="number">73</span><span class="type">e39439a262</span>]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">37.120</span> <span class="type">ERROR</span> <span class="number">2688</span> --- [<span class="type">ntContainer</span><span class="comment">#1-1] t.p.b.BusinessWarningMessageReceiver     : 『warning』 receive unroutable message: [FlowerK]</span></span><br></pre></td></tr></table></figure>

<p>可以看到，两条消息都可以收到成功回调，但是不可路由消息不会回退给生产者，而是直接转发到备份交换机，可见备份交换机的处理优先级更高。</p>
<h3 id="9-5-一个小结"><a href="#9-5-一个小结" class="headerlink" title="9.5 一个小结"></a>9.5 一个小结</h3><p>事务机制和生产者确认机制保证消息成功发送到RabbitMQ的Broker，生产者确认机制跟事务是不能一起工作的，它是事务的轻量级替代方案。因为事务和发布者确认模式都是需要先跟服务器协商，对信道启用的一种模式，不能对同一个信道同时使用两种模式。在生产者确认模式中，消息的确认可以是异步和批量的，所以相比使用事务，性能会更好。</p>
<p>想要保证消息成功被exchange路由到队列，可以采用<code>mandatory</code>参数和备份交换机两种方式，两者可以同时启用，备份交换机的处理优先级会更高。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://www.parak.top">Khighness</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.parak.top/posts/33708">https://www.parak.top/posts/33708</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"> CC BY-NC-SA 4.0 </a>许可协议。转载请注明来自<a href="https://www.parak.top">炒菜K殿下</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MQ/">MQ</a></div><div class="post_share"><div class="social-share" data-image="https://khighness-blog.oss-cn-shanghai.aliyuncs.com/top/bg-46.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://khighness-blog.oss-cn-shanghai.aliyuncs.com/avatar/wepay.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="https://khighness-blog.oss-cn-shanghai.aliyuncs.com/avatar/wepay.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://khighness-blog.oss-cn-shanghai.aliyuncs.com/avatar/alipay.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="https://khighness-blog.oss-cn-shanghai.aliyuncs.com/avatar/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/7340/"><img class="prev-cover" data-lazy-src="https://khighness-blog.oss-cn-shanghai.aliyuncs.com/top/bg-47.jpg" onerror="onerror=null;src='https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">ZooKeeper</div></div></a></div><div class="next-post pull-right"><a href="/posts/48247/"><img class="next-cover" data-lazy-src="https://khighness-blog.oss-cn-shanghai.aliyuncs.com/top/bg-45.jpg" onerror="onerror=null;src='https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">盛夏</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%A6%82%E8%BF%B0"><span class="toc-text">1. 消息队列概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%AE%9A%E4%B9%89"><span class="toc-text">1.1 定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">1.2 应用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E4%B8%BB%E6%B5%81%E4%BD%BF%E7%94%A8"><span class="toc-text">1.3 主流使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%8D%8F%E8%AE%AE"><span class="toc-text">2. 消息队列协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-AMQP%E5%8D%8F%E8%AE%AE"><span class="toc-text">2.1 AMQP协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-MQTT%E5%8D%8F%E8%AE%AE"><span class="toc-text">2.2 MQTT协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-OpenMeesage%E5%8D%8F%E8%AE%AE"><span class="toc-text">2.3 OpenMeesage协议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-RabbitMQ%E4%BB%8B%E7%BB%8D"><span class="toc-text">3. RabbitMQ介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-text">3.1 架构设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%85%B6%E4%BB%96%E6%A6%82%E5%BF%B5"><span class="toc-text">3.2 其他概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%B1%BB%E5%9E%8B"><span class="toc-text">3.3 交换机类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-RabbitMQ%E5%AE%89%E8%A3%85"><span class="toc-text">4. RabbitMQ安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-docker%E5%AE%89%E8%A3%85"><span class="toc-text">4.1 docker安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-web%E7%AE%A1%E7%90%86"><span class="toc-text">4.2 web管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-RabbitMQ%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B"><span class="toc-text">5. RabbitMQ消息模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-Hello-World%E6%A8%A1%E5%9E%8B"><span class="toc-text">5.1 Hello World模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-Work-Queues%E6%A8%A1%E5%9E%8B"><span class="toc-text">5.2 Work Queues模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-Publish-Subscribe%E6%A8%A1%E5%9E%8B"><span class="toc-text">5.3 Publish&#x2F;Subscribe模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-Routing%E6%A8%A1%E5%9E%8B"><span class="toc-text">5.4 Routing模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-Topics%E6%A8%A1%E5%9E%8B"><span class="toc-text">5.5 Topics模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-RabbitMQ%E6%95%B4%E5%90%88SpringBoot"><span class="toc-text">6. RabbitMQ整合SpringBoot</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-text">6.1 配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-text">6.2 生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-text">6.3 消费者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-text">6.4 启动类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-RabbitMQ%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-text">7. RabbitMQ死信队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-text">7.1 死信队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">7.2 实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E5%85%B7%E4%BD%93%E7%BC%96%E7%A0%81"><span class="toc-text">7.3 具体编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-%E6%B6%88%E6%81%AF%E5%8F%98%E5%8C%96"><span class="toc-text">7.4 消息变化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">7.5 应用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">7.6 生命周期</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-RabbitMQ%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97"><span class="toc-text">8. RabbitMQ延时队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97"><span class="toc-text">8.1 延时队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">8.2 使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-RabbitMQ-TTL"><span class="toc-text">8.3 RabbitMQ-TTL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">8.4 实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-%E5%85%B7%E4%BD%93%E7%BC%96%E7%A0%81"><span class="toc-text">8.5 具体编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-6-%E9%98%9F%E5%88%97%E4%BC%98%E5%8C%96"><span class="toc-text">8.6 队列优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-7-%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0"><span class="toc-text">8.7 插件实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-8-%E4%B8%80%E4%B8%AA%E5%B0%8F%E7%BB%93"><span class="toc-text">8.8 一个小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-RabbitMQ%E5%8F%AF%E9%9D%A0%E6%8A%95%E9%80%92"><span class="toc-text">9. RabbitMQ可靠投递</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E5%8F%AF%E9%9D%A0%E6%8A%95%E9%80%92"><span class="toc-text">9.1 可靠投递</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">9.2 实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6"><span class="toc-text">9.3 事务机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-4-%E7%94%9F%E4%BA%A7%E8%80%85%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6"><span class="toc-text">9.4 生产者确认机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-6-%E5%8F%AF%E9%9D%A0%E6%8A%95%E9%80%92%E5%88%B0%E9%98%9F%E5%88%97"><span class="toc-text">9.6 可靠投递到队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-5-%E4%B8%80%E4%B8%AA%E5%B0%8F%E7%BB%93"><span class="toc-text">9.5 一个小结</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background: gray"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Khighness</div><div class="footer_custom_text"><a href="https://www.foreverblog.cn/" target="_blank" > <img src="https://img.foreverblog.cn/logo_en_default.png" alt="" style="width:auto;height:16px;"> </a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">簡</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      true && mermaid.init()
    })
  }
}</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'Py2eOHzSdrnxKPzKrOJaHJOq-9Nh9j0Va',
      appKey: '9eQhwuCgyshpYKn4rtEhqt4R',
      placeholder: '',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: true,
      serverURLs: '',
      emojiCDN: 'https://cdn.jsdelivr.net/gh/Khighness/cdn/js/emotion.json',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
      requiredFields: ["nick, mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://unpkg.com/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="//code.tidio.co/ao1f4qdjllf8yowzz7v5brdaejt42uoi.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>function history_calendar_injector_config(){
                var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
                var item_html = '<div class="card-widget card-history"><div class="card-content"><div class="item-headline"><i class="fas fa-clock fa-spin"></i><span>那年今日</span></div><div id="history-baidu" style="height: 100px;overflow: hidden"><div class="history_swiper-container" id="history-container" style="width: 100%;height: 100%"><div class="swiper-wrapper" id="history_container_wrapper" style="height:20px"></div></div></div></div>';
                console.log('已挂载history_calendar')
                // parent_div_git.innerHTML=item_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",item_html) // 有报错，但不影响使用(支持pjax跳转)
            }if( document.getElementsByClassName('sticky_layout')[0] && (location.pathname ==='/'|| '/' ==='all')){

            history_calendar_injector_config()
        } </script><script data-pjax  src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/js/main.js"></script><!-- hexo injector body_end end --></body></html>